{"version":3,"sources":["app.js"],"names":["TILE_DESCRIPTIONS","R45","Math","PI","R90","R360","Viewport","init","canvas","document","getElementById","ctx","getContext","resize","force","dpi","window","devicePixelRatio","width","clientWidth","height","clientHeight","dpiWidth","dpiHeight","scale","max","ceil","center","u","v","imageSmoothingEnabled","style","cursor","fillViewportRect","fillRect","KeyboardAdapter","map","KeyW","Input","Action","UP","KeyA","LEFT","KeyS","DOWN","KeyD","RIGHT","ArrowUp","ArrowLeft","ArrowDown","ArrowRight","Escape","MENU","arrowDirections","x","y","m","held","addEventListener","event","k","code","reset","update","state","direction","action","Object","values","zzfx","t","zzfxP","zzfxG","e","zzfxX","createBufferSource","f","createBuffer","length","zzfxR","d","i","getChannelData","set","buffer","connect","destination_","start","q","c","r","F","z","w","A","l","B","G","C","p","h","b","H","I","D","random","Z","g","E","a","n","J","K","sin","min","tan","abs","round","zzfxV","top","AudioContext","webkitAudioContext","destination","CPlayer","mSong","mLastRow","mCurrentCol","mNumWords","mMixBuf","osc_sin","value","getnotefreq","createNote","instr","rowLen","j","j2","rsample","o1t","o2t","osc1","mOscillators","o1vol","o1xenv","osc2","o2vol","o2xenv","noiseVol","attack","sustain","release","releaseInv","expDecay","arp","arpInterval","noteBuf","Int32Array","c1","c2","v2","this","song","endPattern","patternLen","generate","row","col","cp","rowStartSample","high","lsample","chnBuf","songData","low","band","filterActive","noteCache","cmdNo","oscLFO","lfoAmt","lfoFreq","fxLFO","fxFilter","fxFreq","dist","drive","panAmt","panFreq","dlyAmt","dly","numChannels","createAudioBuffer","context","data","createWave","l1","l2","wave","Uint8Array","idx","getData","floor","Array","Audio","readyToPlay","gain_","createGain","shellReload","damage","alarm","victory","mothDeath","towerShoot","ghostDeath","buildingFinished","waveCountdown","player","console","log","songSource","musicPlaying","play","sound","pause","gain","linearRampToValueAtTime","currentTime","unpause","MouseAdapter","RAW_TOUCH","RELOAD","pointer","clientX","clientY","mode","button","game","frogger","pointerDragStart","preventDefault","releaseRMBTick","TouchAdapter","changedTouches","ATTACK","MUTE","FREEZE","DRAG","TAP","pressed","released","framesHeld","dragging","pointerAdapter","dragVector","onDown","onUp","C_SHIFT","C_ICONS","Text","white","Sprite","font","img","icons","buildings","icon","black","recolor","rgba","black_shadow","blue","blue_shadow","shadow","red","duotone","recolorDuotone","duotone_red","drawText","text","charCodeAt","drawImage","C_WIDTH","drawParagraph","cu","cv","phrases","split","phrase","slice","phraseWidth","measureWidth","reduce","sum","color","createCanvas","fillStyle","globalCompositeOperation","topColor","bottomColor","tint","C_HEIGHT","ScreenShake","constructor","frames","hAmplitude","vAmplitude","hSamples","vSamples","sampleCount","push","frame","s","s0","s1","decay","Gore","pos","angle","vel","vector2point","angle2vector","noClipEntity","bounce","radius","noClipWall","think","cull","draw","drawViewportSprite","gore","entity","spray","kill","count","cb","lastDamage","atan2","vector","vectorAdd","entities","WorldData","_t","name","$t","ti","ii","si","id","bounds","hi","Moth","target","hp","lightlevel","tasks","carrying","offset","carryAmount","carryCapacity","carryPerFrame","transferAmount","circleOffset","lastAssigned","qr","xy2qr","moveTo","task","centerxy","qr2xy","vectorBetween","pop","building","World","buildingAt","buildFrames","buildFramesTotal","resourcesLeft","spawn","earth","pathToTarget","clamp","newVelocity","uv","cos","moth","gather","construct","isBusy","sortMoths","moths","filter","sort","assign","fn","TowerGunk","diff","amount","knockback","bullet1","BuildTowerAction","defaultTapAction","selected","buttonSprite","buttons","buttonSelectedSprite","drawSelectedText","canAfford","tap","payCost","TowerBuilding","framesToNextShot","title","portraitSprite","closestTarget","closestVector","xy","enemy","xy2uv","globalAlpha","progress","hud_wip","hudActions","SPAWN_COST_EARTH","SpawnMothAction","cost","activeMoths","CoffinBuilding","Ghost","mass","lastAttack","targets","bestTarget","bestDiff","sprite","ghost","GatherEarthAction","EarthBuilding","MoveAction","Movement","perform","movers","rounds","clipVelocityEntityVsEntity","clipVelocityAgainstWalls","other","hit","p1","r1","v1","p2","r2","delta","nx","ny","entityM","normalizeVector","otherM","entityI","otherI","tile","tileIsPassable","intersectCircleRectangle","Damage","HealthChunkAnimation","WAVES","Wave","waveNumber","upcoming","countdown","incoming","lastFrame","monstersPending","VictoryScreen","message","ExitBuilding","screen","tiles","floors","drawLightmap","lightmap","fogofwar","tile_background","objects","object","exit","array2d","cachedFields","makePrettyWalls","updateLightmap","canMoveInto","tileAt","isSeeThrough","SEE_THROUGH","includes","refreshVisible","uv2xy","actions","lights","light","maze","froms","maxDistance","Infinity","result","stack","di","Ts","shift","tileOnMap","from","to","qrFrom","qrTo","qr1","qr2","key","join","field","xs","keys","options","option","bitmask","getDynamicTile","TRAY_HEIGHT","Hud","wipCanvas","selectedAction","seconds","clearRect","beginPath","lineTo","arc","fill","selectedActionIndex","cornerText","cornerWidth","toString","padStart","hud_tray_divider","uvAction","uvTrayAction","hud_tray_popup","dialog","hud_mouse","undefined","Camera","forceTarget","dragStart","sqrt","vectors","TILE_SIZE","dx","dy","invdx","invdy","cornerX","cornerY","ltime","ly","ix","iy","rtime","ry","ttime","tx","btime","bx","inverseRadius","lineLength","cornerdx","cornerdy","cornerDistance","innerAngle","acos","time","isNaN","innerAngleSin","angle1Sin","angle1","asin","angle2","createElement","SpriteSheet","hud_crosshair","hud_tray_building","icon_mouse","walls","base64","loadSpritesheet","image","Image","onload","src","sheet","initBasicSprite","icon_mouse_lmb","icon_mouse_rmb","tilebg","initDynamicSprite","source","gradient","createRadialGradient","addColorStop","drawSprite","anchor","rotation","o","viewportSprite2uv","save","translate","rotate","restore","TILE_CORNER_OUTER","TILE_WALL_LEFT","TILE_WALL_RIGHT","TILE_WALL_TOP","TILE_WALL_BOTTOM","TILE_CORNER_INNER","sliceCanvas","DefeatScreen","dialogPending","dialogSeen","roomsCleared","shadowOffset","screenshakes","blood","framestamps","requestAnimationFrame","xyz","onFrame","currentms","startTime","Date","getTime","fps","endTime","paused","spawnMonsterIfPossible","screenshake","started","setTransform","ui","entityClass"],"mappings":"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CACA,OAAOoB,CACX,CACJ,EASUiF,EAAO,CACTW,EAAU,CACR,CACE3F,EAAG,CACH,EACA,IACA,IACA,EACA,EACA,IACA,IACA,EACA,EACA,EACA,EACA,GACA,GACA,EACA,EACA,EACA,EACA,GACA,EACA,EACA,EACA,GACA,IACA,EACA,GACA,GACA,EACA,GACA,GAGAkB,EAAG,GAEHV,EAAG,IAGL,CACER,EAAG,CACH,EACA,IACA,IACA,GACA,EACA,IACA,IACA,EACA,GACA,EACA,EACA,EACA,GACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,GACA,EACA,EACA,GACA,GACA,EACA,EACA,GAGAkB,EAAG,GAEHV,EAAG,IAGL,CACER,EAAG,CACH,EACA,IACA,IACA,GACA,EACA,IACA,IACA,EACA,GACA,EACA,EACA,EACA,GACA,GACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,GACA,EACA,EACA,GACA,EACA,EACA,EACA,GAGAkB,EAAG,CAAC,EAAE,EAAE,EAAE,GAEVV,EAAG,CACD,CAACqB,EAAG,GACHlC,EAAG,IACJ,CAACkC,EAAG,GACHlC,EAAG,IACJ,CAACkC,EAAG,GACHlC,EAAG,IACJ,CAACkC,EAAG,CAAC,IAAI,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,KACpDlC,EAAG,MAGR,CACEK,EAAG,CACH,EACA,IACA,IACA,GACA,EACA,GACA,GACA,EACA,EACA,EACA,EACA,EACA,GACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,GACA,GACA,EACA,EACA,GAGAkB,EAAG,CAAC,EAAE,EAAE,EAAE,GAEVV,EAAG,CACD,CAACqB,EAAG,GACHlC,EAAG,IACJ,CAACkC,EAAG,GACHlC,EAAG,IACJ,CAACkC,EAAG,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,C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,EAAQ3T,KAAKuG,SAAWrG,EAAMH,EAAK6U,KAEvD,GAOJ,MAAMM,EAEN,CACIC,GAAU,CACN,CACIC,KAAQ,KACRC,GAAS,CACL,CACI,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,GACA,GACA,GACA,GACA,GACA,GACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,GACA,GACA,GACA,GACA,GACA,EACA,EACA,GAEJ,CACI,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,GACA,GACA,GACA,EACA,EACA,EACA,EACA,GACA,GACA,GACA,EACA,EACA,EACA,EACA,EACA,GACA,GACA,EACA,EACA,EACA,GACA,GACA,EACA,GAEJ,CACI,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,GACA,GACA,GACA,GACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,GACA,GACA,EACA,EACA,GACA,GACA,GACA,EACA,EACA,EACA,EACA,EACA,GACA,GACA,GAEJ,CACI,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,GACA,GACA,GACA,GACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,GACA,GACA,GACA,GACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,GACA,GAEJ,CACI,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,GACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,GACA,GAEJ,CACI,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,GACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,GACA,GACA,GAEJ,CACI,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,GACA,GACA,GACA,GACA,GACA,GACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,GACA,GACA,GACA,EACA,GAEJ,CACI,EACA,EACA,EACA,EACA,EACA,EACA,EACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,EACA,EACA,EACA,GACA,GACA,GACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,GACA,GACA,EACA,EACA,EACA,GAEJ,CACI,EACA,EACA,EACA,EACA,EACA,EACA,GACA,GACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,GACA,GACA,GACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,GACA,GACA,GACA,GACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,GACA,GACA,GACA,GACA,GAEJ,CACI,EACA,EACA,EACA,EACA,EACA,GACA,GACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,GACA,GACA,GACA,EACA,EACA,EACA,EACA,GACA,GACA,GACA,GACA,GACA,EACA,GACA,GACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,GACA,IAEJ,CACI,EACA,EACA,EACA,EACA,EACA,GACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,GACA,EACA,EACA,EACA,EACA,GACA,EACA,EACA,EACA,EACA,EACA,EACA,IAEJ,CACI,EACA,EACA,EACA,EACA,EACA,GACA,EACA,EACA,EACA,EACA,EACA,GACA,GACA,GACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,GACA,EACA,EACA,EACA,EACA,GACA,GACA,EACA,EACA,EACA,EACA,EACA,IAEJ,CACI,EACA,EACA,EACA,EACA,EACA,GACA,EACA,EACA,EACA,EACA,GACA,GACA,EACA,GACA,GACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,GACA,EACA,EACA,EACA,GACA,GACA,GACA,EACA,EACA,EACA,EACA,EACA,IAEJ,CACI,EACA,EACA,EACA,EACA,EACA,GACA,GACA,EACA,EACA,GACA,GACA,EACA,EACA,GACA,GACA,EACA,EACA,EACA,EACA,EACA,GACA,GACA,GACA,GACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,GACA,GACA,EACA,EACA,EACA,GACA,EACA,GACA,GACA,EACA,EACA,EACA,GACA,IAEJ,CACI,EACA,EACA,EACA,EACA,EACA,EACA,GACA,GACA,GACA,GACA,EACA,EACA,GACA,GACA,EACA,EACA,EACA,EACA,EACA,GACA,GACA,EACA,EACA,GACA,GACA,EACA,EACA,EACA,EACA,EACA,EACA,GACA,GACA,GACA,EACA,EACA,EACA,GACA,EACA,EACA,GACA,GACA,GACA,GACA,GACA,GAEJ,CACI,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,GACA,EACA,EACA,EACA,EACA,EACA,EACA,GACA,EACA,EACA,EACA,EACA,GACA,GACA,EACA,EACA,EACA,EACA,EACA,GACA,GACA,GACA,EACA,EACA,EACA,GACA,GACA,EACA,EACA,EACA,EACA,EACA,EACA,GAEJ,CACI,EACA,EACA,EACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,EACA,EACA,EACA,EACA,GACA,GACA,GACA,EACA,EACA,EACA,EACA,EACA,GACA,EACA,EACA,EACA,EACA,EACA,EACA,GACA,EACA,EACA,EACA,EACA,EACA,GACA,EACA,EACA,EACA,EACA,EACA,EACA,GAEJ,CACI,EACA,GACA,GACA,GACA,EACA,EACA,EACA,EACA,EACA,GACA,GACA,GACA,GACA,EACA,EACA,EACA,EACA,GACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,GACA,GACA,EACA,EACA,EACA,EACA,EACA,GACA,EACA,EACA,EACA,EACA,EACA,GACA,GACA,EACA,EACA,EACA,EACA,EACA,GAEJ,CACI,EACA,GACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,GACA,GACA,GACA,EACA,EACA,EACA,EACA,GACA,GACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,GACA,EACA,EACA,EACA,EACA,EACA,GACA,GACA,GACA,EACA,EACA,EACA,EACA,GACA,EACA,EACA,EACA,EACA,EACA,GAEJ,CACI,GACA,GACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,GACA,GACA,GACA,EACA,EACA,EACA,EACA,EACA,GACA,GACA,EACA,EACA,EACA,EACA,EACA,EACA,GACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,GACA,GACA,EACA,EACA,EACA,GACA,EACA,EACA,EACA,EACA,EACA,GAEJ,CACI,GACA,EACA,EACA,EACA,EACA,GACA,EACA,EACA,EACA,EACA,EACA,GACA,GACA,GACA,EACA,EACA,EACA,EACA,GACA,GACA,EACA,EACA,EACA,EACA,EACA,EACA,GACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,GACA,EACA,EACA,EACA,GACA,GACA,GACA,GACA,GACA,EACA,GAEJ,CACI,GACA,EACA,EACA,EACA,EACA,GACA,GACA,EACA,EACA,EACA,EACA,GACA,GACA,GACA,GACA,EACA,EACA,EACA,GACA,GACA,EACA,EACA,EACA,EACA,EACA,EACA,GACA,GACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,GACA,EACA,EACA,EACA,GACA,GACA,EACA,EACA,GACA,GACA,GAEJ,CACI,GACA,EACA,EACA,EACA,EACA,GACA,GACA,EACA,EACA,EACA,EACA,EACA,GACA,GACA,GACA,EACA,EACA,EACA,EACA,GACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,GACA,GACA,EACA,EACA,EACA,EACA,EACA,EACA,GACA,GACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,GACA,GAEJ,CACI,GACA,GACA,EACA,EACA,EACA,GACA,GACA,EACA,EACA,EACA,EACA,EACA,EACA,GACA,GACA,EACA,EACA,EACA,EACA,GACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,GACA,GACA,EACA,EACA,EACA,EACA,GACA,GACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,GACA,GAEJ,CACI,EACA,GACA,EACA,EACA,EACA,GACA,GACA,GACA,EACA,EACA,EACA,EACA,EACA,GACA,GACA,EACA,EACA,EACA,EACA,GACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,GACA,GACA,GACA,GACA,GACA,GACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,GACA,GAEJ,CACI,EACA,GACA,EACA,EACA,EACA,EACA,GACA,GACA,GACA,EACA,EACA,EACA,GACA,GACA,GACA,EACA,EACA,EACA,EACA,GACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,GACA,GACA,EACA,EACA,EACA,EACA,GACA,GACA,GACA,EACA,EACA,EACA,GACA,GACA,GAEJ,CACI,EACA,GACA,EACA,EACA,EACA,EACA,EACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,EACA,EACA,EACA,EACA,GACA,GACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,GACA,GACA,EACA,EACA,EACA,EACA,EACA,GACA,EACA,GACA,GACA,GACA,GACA,GACA,EACA,GAEJ,CACI,EACA,GACA,GACA,EACA,EACA,EACA,EACA,EACA,GACA,GACA,GACA,GACA,GACA,EACA,EACA,EACA,EACA,GACA,GACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,GACA,EACA,EACA,EACA,GACA,GACA,GACA,GACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,GAEJ,CACI,EACA,EACA,GACA,GACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,GACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,GACA,EACA,EACA,GACA,GACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,GAEJ,CACI,EACA,EACA,EACA,GACA,GACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,GACA,GACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,GACA,GACA,GACA,GACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,GAEJ,CACI,EACA,EACA,EACA,EACA,GACA,GACA,GACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,GACA,GACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,GAEJ,CACI,EACA,EACA,EACA,EACA,EACA,EACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,IAGRC,GAAS,GACTC,GAAW,CACP,CACIH,KAAQ,QACRhS,EAAK,GACLC,EAAK,IAET,CACI+R,KAAQ,QACRhS,EAAK,GACLC,EAAK,GAET,CACI+R,KAAQ,OACRhS,EAAK,GACLC,EAAK,IAET,CACI+R,KAAQ,QACRhS,EAAK,GACLC,EAAK,IAET,CACI+R,KAAQ,QACRhS,EAAK,GACLC,EAAK,IAET,CACI+R,KAAQ,QACRhS,EAAK,GACLC,EAAK,IAET,CACI+R,KAAQ,QACRhS,EAAK,GACLC,EAAK,GAET,CACI+R,KAAQ,QACRhS,EAAK,GACLC,EAAK,GAET,CACI+R,KAAQ,QACRhS,EAAK,GACLC,EAAK,GAET,CACI+R,KAAQ,QACRhS,EAAK,GACLC,EAAK,IAET,CACI+R,KAAQ,QACRhS,EAAK,EACLC,EAAK,KAGbmS,GAAY,GACZC,GAAM,IAGdC,OAAU,CACN,CACI,EACA,GAEJ,CACI,GACA,KAGRC,GAAS,CACL,GACA,GACA,IASR,MAAMC,EACFhD,YAAYc,GACR5J,KAAK4J,GAAM,IAAKA,GAChB5J,KAAK+L,OAAS,IAAK/L,KAAK4J,IACxB5J,KAAK8J,GAAM,CAAExQ,EAAG,EAAGC,EAAG,GACtByG,KAAKgM,GAAK,EACVhM,KAAKgD,EAAS,GACdhD,KAAKmK,GAAS,EACdnK,KAAKhG,GA58FK,EA68FVgG,KAAKiK,IAAAA,EACLjK,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","file":"app.js","sourcesContent":["(function () {\n    'use strict';\n\n    // Constants\n\n    // The game's desired dimensions in pixels - the actual dimensions can be adjusted\n    // slightly by the Viewport module.\n    const TARGET_GAME_WIDTH = 240; //320; //480;\n    const TARGET_GAME_HEIGHT = 135; //180; //270;\n\n    // Size in pixels of each map tile\n    const TILE_SIZE   = 8;\n\n    const INPUT_MODE_TOUCH = 1;\n    const INPUT_MODE_MOUSE = 2;\n    const TILE_WALL_TOP = 9;\n    const TILE_WALL_RIGHT = 10;\n    const TILE_WALL_BOTTOM = 11;\n    const TILE_WALL_LEFT = 12;\n    const TILE_CORNER_OUTER = 13;\n    const TILE_CORNER_INNER = 14;\n    const TILE_DYNAMIC = 20;\n\n    const TILE_DESCRIPTIONS = [\n        'CAVE FLOOR',\n        'CAVE FLOOR',\n        'CAVE FLOOR',\n        '',\n        '',\n        '',\n        'DOOM PIT',\n        'DOOM PIT'\n    ];\n\n    // Some pre-calculated radian values\n    const R0          =   0;\n    const R45         =  45 * Math.PI / 180;\n    const R90         =  90 * Math.PI / 180;\n    const R360        = 360 * Math.PI / 180;\n\n    // Moths must be within this number of pixels of their target\n    // to \"act\" (construct, gather, etc.).\n    const ACTION_DISTANCE = 6;\n\n    // Entity behaviors (states)\n    const SPAWN     = 1;\n    const IDLE      = 2;\n    const MOVE      = 3;\n    const PICKUP    = 4;\n    const DROPOFF   = 5;\n    const CONSTRUCT = 6;\n    const DEAD      = 9;\n\n    // Additional behaviors (enemies)\n    const CHASE     = 11;\n\n    // Additional behaviors (buildings)\n    const WIP       = 21;\n    const ONLINE    = 22;\n\n    // Viewport\n\n    /**\n     * Viewport\n     *\n     * Represents the game display (for us, a canvas).\n     */\n    const Viewport = {\n        init() {\n            Viewport.canvas = document.getElementById('canvas');\n            Viewport.ctx = Viewport.canvas.getContext('2d');\n            Viewport.resize(true);\n        },\n\n        // Resize the canvas to give us approximately our desired game display size.\n        //\n        // Rather than attempt to explain it, here's a concrete example:\n        //\n        //     we start with a desired game dimension:   480x270px\n        //          get the actual browser dimensions:  1309x468px\n        //          factor in the display's DPI ratio:  2618x936px\n        //         now calculate the horizontal scale:       5.45x\n        //                     and the vertical scale:       3.46x\n        //            our new offical game scaling is:        5.4x\n        //       and our official viewport dimensions:   484x173px\n        //\n        // This approach emphasizes correct aspect ratio and maintains full-window rendering, at\n        // the potential cost of limiting visibility of the game itself in either the X or Y axis.\n        // If you use this approach, make sure your GUI can \"float\" (otherwise there may be whole\n        // UI elements the player cannot see!).\n        resize(force) {\n            let dpi = window.devicePixelRatio,\n                width = Viewport.canvas.clientWidth,\n                height = Viewport.canvas.clientHeight,\n                dpiWidth = width * dpi,\n                dpiHeight = height * dpi;\n\n            if (\n                force ||\n                Viewport.canvas.width !== dpiWidth ||\n                Viewport.canvas.height !== dpiHeight\n            ) {\n                Viewport.canvas.width = dpiWidth;\n                Viewport.canvas.height = dpiHeight;\n\n                Viewport.scale = ((Math.max(dpiWidth / TARGET_GAME_WIDTH, dpiHeight / TARGET_GAME_HEIGHT) * 10) | 0) / 10;\n                Viewport.width = Math.ceil(dpiWidth / Viewport.scale);\n                Viewport.height = Math.ceil(dpiHeight / Viewport.scale);\n                Viewport.center = {\n                    u: (Viewport.width / 2) | 0,\n                    v: (Viewport.height / 2) | 0\n                };\n                Viewport.clientWidth = width;\n                Viewport.clientHeight = height;\n\n                // Note: smoothing flag gets reset on every resize by some browsers, which is why\n                // we do it here.\n                Viewport.ctx.imageSmoothingEnabled = false;\n            }\n\n            // We do this every frame, not just on resize, due to browser sometimes \"forgetting\".\n            Viewport.canvas.style.cursor = 'none';\n        },\n\n        fillViewportRect() {\n            Viewport.ctx.fillRect(0, 0, Viewport.width, Viewport.height);\n        }\n    };\n\n    /**\n     * KeyboardAdapter\n     *\n     * Maps keyboard inputs to game inputs.\n     */\n    const KeyboardAdapter = {\n        init() {\n            KeyboardAdapter.map = {\n                KeyW:        Input.Action.UP,\n                KeyA:        Input.Action.LEFT,\n                KeyS:        Input.Action.DOWN,\n                KeyD:        Input.Action.RIGHT,\n                ArrowUp:     Input.Action.UP,\n                ArrowLeft:   Input.Action.LEFT,\n                ArrowDown:   Input.Action.DOWN,\n                ArrowRight:  Input.Action.RIGHT,\n                Escape:      Input.Action.MENU\n            };\n\n            // For keyboard, we support 8-point movement (S, E, SE, etc.)\n            KeyboardAdapter.arrowDirections = [\n                { x:   R0, y:   R0, m: 0 },\n                { x:   R0, y: -R90, m: 1 },\n                { x:   R0, y:  R90, m: 1 },\n                { x:   R0, y:   R0, m: 0 },\n                { x: -R90, y:   R0, m: 1 },\n                { x: -R45, y: -R45, m: 1 },\n                { x: -R45, y:  R45, m: 1 },\n                { x: -R90, y:   R0, m: 1 },\n                { x:  R90, y:   R0, m: 1 },\n                { x:  R45, y: -R45, m: 1 },\n                { x:  R45, y:  R45, m: 1 },\n                { x:  R90, y:   R0, m: 1 },\n                { x:   R0, y:   R0, m: 0 },\n                { x:   R0, y: -R90, m: 1 },\n                { x:   R0, y:  R90, m: 1 },\n                { x:   R0, y:   R0, m: 0 }\n            ];\n\n            KeyboardAdapter.held = [];\n\n            window.addEventListener('keydown', event => {\n                let k = KeyboardAdapter.map[event.code];\n                // Debugging - key presses\n                // console.log(event.key, event.keyCode, event.code, k);\n                if (k) {\n                    KeyboardAdapter.held[k] = true;\n                }\n            });\n\n            window.addEventListener('keyup', event => {\n                let k = KeyboardAdapter.map[event.code];\n                if (k) {\n                    KeyboardAdapter.held[k] = false;\n                }\n            });\n\n            KeyboardAdapter.reset();\n        },\n\n        update() {\n            // For keyboards, we want to convert the state of the various arrow keys being held down\n            // into a directional vector. We use the browser's event to handle the held state of\n            // the other action buttons, so we don't need to process them here.\n            let state =\n                (KeyboardAdapter.held[Input.Action.UP] ? 1 : 0) +\n                (KeyboardAdapter.held[Input.Action.DOWN] ? 2 : 0) +\n                (KeyboardAdapter.held[Input.Action.LEFT] ? 4 : 0) +\n                (KeyboardAdapter.held[Input.Action.RIGHT] ? 8 : 0);\n\n            KeyboardAdapter.direction = KeyboardAdapter.arrowDirections[state];\n        },\n\n        reset() {\n            KeyboardAdapter.direction = KeyboardAdapter.arrowDirections[0];\n            for (let action of Object.values(Input.Action)) {\n                KeyboardAdapter.held[action] = false;\n            }\n        }\n    };\n\n    // zzfx() - the universal entry point -- returns a AudioBufferSourceNode\n    const zzfx=(...t)=>zzfxP(zzfxG(...t));\n\n    // zzfxP() - the sound player -- returns a AudioBufferSourceNode\n    const zzfxP=(...t)=>{let e=zzfxX.createBufferSource(),f=zzfxX.createBuffer(t.length,t[0].length,zzfxR);t.map((d,i)=>f.getChannelData(i).set(d)),e.buffer=f,e.connect(zzfx.destination_),e.start();return e};\n\n    // zzfxG() - the sound generator -- returns an array of sample data\n    const zzfxG=(q=1,k=.05,c=220,e=0,t=0,u=.1,r=0,F=1,v=0,z=0,w=0,A=0,l=0,B=0,x=0,G=0,d=0,y=1,m=0,C=0)=>{let b=2*Math.PI,H=v*=500*b/zzfxR**2,I=(0<x?1:-1)*b/4,D=c*=(1+2*k*Math.random()-k)*b/zzfxR,Z=[],g=0,E=0,a=0,n=1,J=0,K=0,f=0,p,h;e=99+zzfxR*e;m*=zzfxR;t*=zzfxR;u*=zzfxR;d*=zzfxR;z*=500*b/zzfxR**3;x*=b/zzfxR;w*=b/zzfxR;A*=zzfxR;l=zzfxR*l|0;for(h=e+m+t+u+d|0;a<h;Z[a++]=f)++K%(100*G|0)||(f=r?1<r?2<r?3<r?Math.sin((g%b)**3):Math.max(Math.min(Math.tan(g),1),-1):1-(2*g/b%2+2)%2:1-4*Math.abs(Math.round(g/b)-g/b):Math.sin(g),f=(l?1-C+C*Math.sin(2*Math.PI*a/l):1)*(0<f?1:-1)*Math.abs(f)**F*q*zzfxV*(a<e?a/e:a<e+m?1-(a-e)/m*(1-y):a<e+m+t?y:a<h-d?(h-a-d)/u*y:0),f=d?f/2+(d>a?0:(a<h-d?1:(h-a)/d)*Z[a-d|0]/2):f),p=(c+=v+=z)*Math.sin(E*x-I),g+=p-p*B*(1-1E9*(Math.sin(a)+1)%2),E+=p-p*B*(1-1E9*(Math.sin(a)**2+1)%2),n&&++n>A&&(c+=w,D+=w,n=0),!l||++J%l||(c=D,v=H,n=n||1);return Z};\n\n    // zzfxV - global volume\n    const zzfxV=.3;\n\n    // zzfxR - global sample rate\n    const zzfxR=44100;\n\n    // zzfxX - the common audio context\n    const zzfxX=new(top.AudioContext||webkitAudioContext);\n\n    // destination for zzfx and zzfxm sounds\n    zzfx.destination_ = zzfxX.destination;\n\n    /* -*- mode: javascript; tab-width: 4; indent-tabs-mode: nil; -*-\n    *\n    * Copyright (c) 2011-2013 Marcus Geelnard\n    *\n    * This software is provided 'as-is', without any express or implied\n    * warranty. In no event will the authors be held liable for any damages\n    * arising from the use of this software.\n    *\n    * Permission is granted to anyone to use this software for any purpose,\n    * including commercial applications, and to alter it and redistribute it\n    * freely, subject to the following restrictions:\n    *\n    * 1. The origin of this software must not be misrepresented; you must not\n    *    claim that you wrote the original software. If you use this software\n    *    in a product, an acknowledgment in the product documentation would be\n    *    appreciated but is not required.\n    *\n    * 2. Altered source versions must be plainly marked as such, and must not be\n    *    misrepresented as being the original software.\n    *\n    * 3. This notice may not be removed or altered from any source\n    *    distribution.\n    *\n    */\n\n    // Some general notes and recommendations:\n    //  * This code uses modern ECMAScript features, such as ** instead of\n    //    Math.pow(). You may have to modify the code to make it work on older\n    //    browsers.\n    //  * If you're not using all the functionality (e.g. not all oscillator types,\n    //    or certain effects), you can reduce the size of the player routine even\n    //    further by deleting the code.\n\n\n    const CPlayer = function() {\n\n        //--------------------------------------------------------------------------\n        // Private methods\n        //--------------------------------------------------------------------------\n\n        // Oscillators\n        var osc_sin = function (value) {\n            return Math.sin(value * 6.283184);\n        };\n\n        var osc_saw = function (value) {\n            return 2 * (value % 1) - 1;\n        };\n\n        var osc_square = function (value) {\n            return (value % 1) < 0.5 ? 1 : -1;\n        };\n\n        var osc_tri = function (value) {\n            var v2 = (value % 1) * 4;\n            if(v2 < 2) return v2 - 1;\n            return 3 - v2;\n        };\n\n        var getnotefreq = function (n) {\n            // 174.61.. / 44100 = 0.003959503758 (F3)\n            return 0.003959503758 * (2 ** ((n - 128) / 12));\n        };\n\n        var createNote = function (instr, n, rowLen) {\n            var osc1 = mOscillators[instr.i[0]],\n                o1vol = instr.i[1],\n                o1xenv = instr.i[3]/32,\n                osc2 = mOscillators[instr.i[4]],\n                o2vol = instr.i[5],\n                o2xenv = instr.i[8]/32,\n                noiseVol = instr.i[9],\n                attack = instr.i[10] * instr.i[10] * 4,\n                sustain = instr.i[11] * instr.i[11] * 4,\n                release = instr.i[12] * instr.i[12] * 4,\n                releaseInv = 1 / release,\n                expDecay = -instr.i[13]/16,\n                arp = instr.i[14],\n                arpInterval = rowLen * (2 **(2 - instr.i[15]));\n\n            var noteBuf = new Int32Array(attack + sustain + release);\n\n            // Re-trig oscillators\n            var c1 = 0, c2 = 0;\n\n            // Local variables.\n            var j, j2, e, rsample, o1t, o2t;\n\n            // Generate one note (attack + sustain + release)\n            for (j = 0, j2 = 0; j < attack + sustain + release; j++, j2++) {\n                if (j2 >= 0) {\n                    // Switch arpeggio note.\n                    arp = (arp >> 8) | ((arp & 255) << 4);\n                    j2 -= arpInterval;\n\n                    // Calculate note frequencies for the oscillators\n                    o1t = getnotefreq(n + (arp & 15) + instr.i[2] - 128);\n                    o2t = getnotefreq(n + (arp & 15) + instr.i[6] - 128) * (1 + 0.0008 * instr.i[7]);\n                }\n\n                // Envelope\n                e = 1;\n                if (j < attack) {\n                    e = j / attack;\n                } else if (j >= attack + sustain) {\n                    e = (j - attack - sustain) * releaseInv;\n                    e = (1 - e) * (3 ** (expDecay * e));\n                }\n\n                // Oscillator 1\n                c1 += o1t * e ** o1xenv;\n                rsample = osc1(c1) * o1vol;\n\n                // Oscillator 2\n                c2 += o2t * e ** o2xenv;\n                rsample += osc2(c2) * o2vol;\n\n                // Noise oscillator\n                if (noiseVol) {\n                    rsample += (2 * Math.random() - 1) * noiseVol;\n                }\n\n                // Add to (mono) channel buffer\n                noteBuf[j] = (80 * rsample * e) | 0;\n            }\n\n            return noteBuf;\n        };\n\n\n        //--------------------------------------------------------------------------\n        // Private members\n        //--------------------------------------------------------------------------\n\n        // Array of oscillator functions\n        var mOscillators = [\n            osc_sin,\n            osc_square,\n            osc_saw,\n            osc_tri\n        ];\n\n        // Private variables set up by init()\n        var mSong, mLastRow, mCurrentCol, mNumWords, mMixBuf;\n\n\n        //--------------------------------------------------------------------------\n        // Initialization\n        //--------------------------------------------------------------------------\n\n        this.init = function (song) {\n            // Define the song\n            mSong = song;\n\n            // Init iteration state variables\n            mLastRow = song.endPattern;\n            mCurrentCol = 0;\n\n            // Prepare song info\n            mNumWords =  song.rowLen * song.patternLen * (mLastRow + 1) * 2;\n\n            // Create work buffer (initially cleared)\n            mMixBuf = new Int32Array(mNumWords);\n        };\n\n\n        //--------------------------------------------------------------------------\n        // Public methods\n        //--------------------------------------------------------------------------\n\n        // Generate audio data for a single track\n        this.generate = function () {\n            // Local variables\n            var i, j, p, row, col, n, cp,\n                k, t, rsample, rowStartSample, f;\n\n            // Put performance critical items in local variables\n            var chnBuf = new Int32Array(mNumWords),\n                instr = mSong.songData[mCurrentCol],\n                rowLen = mSong.rowLen,\n                patternLen = mSong.patternLen;\n\n            // Clear effect state\n            var low = 0, band = 0, high;\n            var lsample, filterActive = false;\n\n            // Clear note cache.\n            var noteCache = [];\n\n             // Patterns\n             for (p = 0; p <= mLastRow; ++p) {\n                cp = instr.p[p];\n\n                // Pattern rows\n                for (row = 0; row < patternLen; ++row) {\n                    // Execute effect command.\n                    var cmdNo = cp ? instr.c[cp - 1].f[row] : 0;\n                    if (cmdNo) {\n                        instr.i[cmdNo - 1] = instr.c[cp - 1].f[row + patternLen] || 0;\n\n                        // Clear the note cache since the instrument has changed.\n                        if (cmdNo < 17) {\n                            noteCache = [];\n                        }\n                    }\n\n                    // Put performance critical instrument properties in local variables\n                    var oscLFO = mOscillators[instr.i[16]],\n                        lfoAmt = instr.i[17] / 512,\n                        lfoFreq = (2 ** (instr.i[18] - 9)) / rowLen,\n                        fxLFO = instr.i[19],\n                        fxFilter = instr.i[20],\n                        fxFreq = instr.i[21] * 43.23529 * 3.141592 / 44100,\n                        q = 1 - instr.i[22] / 255,\n                        dist = instr.i[23] * 1e-5,\n                        drive = instr.i[24] / 32,\n                        panAmt = instr.i[25] / 512,\n                        panFreq = 6.283184 * (2 ** (instr.i[26] - 9)) / rowLen,\n                        dlyAmt = instr.i[27] / 255,\n                        dly = instr.i[28] * rowLen & ~1;  // Must be an even number\n\n                    // Calculate start sample number for this row in the pattern\n                    rowStartSample = (p * patternLen + row) * rowLen;\n\n                    // Generate notes for this pattern row\n                    for (col = 0; col < 4; ++col) {\n                        n = cp ? instr.c[cp - 1].n[row + col * patternLen] : 0;\n                        if (n) {\n                            if (!noteCache[n]) {\n                                noteCache[n] = createNote(instr, n, rowLen);\n                            }\n\n                            // Copy note from the note cache\n                            var noteBuf = noteCache[n];\n                            for (j = 0, i = rowStartSample * 2; j < noteBuf.length; j++, i += 2) {\n                              chnBuf[i] += noteBuf[j];\n                            }\n                        }\n                    }\n\n                    // Perform effects for this pattern row\n                    for (j = 0; j < rowLen; j++) {\n                        // Dry mono-sample\n                        k = (rowStartSample + j) * 2;\n                        rsample = chnBuf[k];\n\n                        // We only do effects if we have some sound input\n                        if (rsample || filterActive) {\n                            // State variable filter\n                            f = fxFreq;\n                            if (fxLFO) {\n                                f *= oscLFO(lfoFreq * k) * lfoAmt + 0.5;\n                            }\n                            f = 1.5 * Math.sin(f);\n                            low += f * band;\n                            high = q * (rsample - band) - low;\n                            band += f * high;\n                            rsample = fxFilter == 3 ? band : fxFilter == 1 ? high : low;\n\n                            // Distortion\n                            if (dist) {\n                                rsample *= dist;\n                                rsample = rsample < 1 ? rsample > -1 ? osc_sin(rsample*.25) : -1 : 1;\n                                rsample /= dist;\n                            }\n\n                            // Drive\n                            rsample *= drive;\n\n                            // Is the filter active (i.e. still audiable)?\n                            filterActive = rsample * rsample > 1e-5;\n\n                            // Panning\n                            t = Math.sin(panFreq * k) * panAmt + 0.5;\n                            lsample = rsample * (1 - t);\n                            rsample *= t;\n                        } else {\n                            lsample = 0;\n                        }\n\n                        // Delay is always done, since it does not need sound input\n                        if (k >= dly) {\n                            // Left channel = left + right[-p] * t\n                            lsample += chnBuf[k-dly+1] * dlyAmt;\n\n                            // Right channel = right + left[-p] * t\n                            rsample += chnBuf[k-dly] * dlyAmt;\n                        }\n\n                        // Store in stereo channel buffer (needed for the delay effect)\n                        chnBuf[k] = lsample | 0;\n                        chnBuf[k+1] = rsample | 0;\n\n                        // ...and add to stereo mix buffer\n                        mMixBuf[k] += lsample | 0;\n                        mMixBuf[k+1] += rsample | 0;\n                    }\n                }\n            }\n\n            // Next iteration. Return progress (1.0 == done!).\n            mCurrentCol++;\n            return mCurrentCol / mSong.numChannels;\n        };\n\n        // Create a AudioBuffer from the generated audio data\n        this.createAudioBuffer = function(context) {\n            var buffer = context.createBuffer(2, mNumWords / 2, 44100);\n            for (var i = 0; i < 2; i ++) {\n                var data = buffer.getChannelData(i);\n                for (var j = i; j < mNumWords; j += 2) {\n                    data[j >> 1] = mMixBuf[j] / 65536;\n                }\n            }\n            return buffer;\n        };\n\n        // Create a WAVE formatted Uint8Array from the generated audio data\n        this.createWave = function() {\n            // Create WAVE header\n            var headerLen = 44;\n            var l1 = headerLen + mNumWords * 2 - 8;\n            var l2 = l1 - 36;\n            var wave = new Uint8Array(headerLen + mNumWords * 2);\n            wave.set(\n                [82,73,70,70,\n                 l1 & 255,(l1 >> 8) & 255,(l1 >> 16) & 255,(l1 >> 24) & 255,\n                 87,65,86,69,102,109,116,32,16,0,0,0,1,0,2,0,\n                 68,172,0,0,16,177,2,0,4,0,16,0,100,97,116,97,\n                 l2 & 255,(l2 >> 8) & 255,(l2 >> 16) & 255,(l2 >> 24) & 255]\n            );\n\n            // Append actual wave data\n            for (var i = 0, idx = headerLen; i < mNumWords; ++i) {\n                // Note: We clamp here\n                var y = mMixBuf[i];\n                y = y < -32767 ? -32767 : (y > 32767 ? 32767 : y);\n                wave[idx++] = y & 255;\n                wave[idx++] = (y >> 8) & 255;\n            }\n\n            // Return the WAVE formatted typed array\n            return wave;\n        };\n\n        // Get n samples of wave data at time t [s]. Wave data in range [-2,2].\n        this.getData = function(t, n) {\n            var i = 2 * Math.floor(t * 44100);\n            var d = new Array(n);\n            for (var j = 0; j < 2*n; j += 1) {\n                var k = i + j;\n                d[j] = t > 0 && k < mMixBuf.length ? mMixBuf[k] / 32768 : 0;\n            }\n            return d;\n        };\n    };\n\n    // This music has been exported by SoundBox. You can use it with\n        // http://sb.bitsnbites.eu/player-small.js in your own product.\n\n        // See http://sb.bitsnbites.eu/demo.html for an example of how to\n        // use it in a demo.\n\n        // Song data\n        const song = {\n            songData: [\n              { // Instrument 0\n                i: [\n                1, // OSC1_WAVEFORM\n                192, // OSC1_VOL\n                128, // OSC1_SEMI\n                0, // OSC1_XENV\n                1, // OSC2_WAVEFORM\n                191, // OSC2_VOL\n                116, // OSC2_SEMI\n                9, // OSC2_DETUNE\n                0, // OSC2_XENV\n                0, // NOISE_VOL\n                6, // ENV_ATTACK\n                22, // ENV_SUSTAIN\n                34, // ENV_RELEASE\n                0, // ENV_EXP_DECAY\n                0, // ARP_CHORD\n                0, // ARP_SPEED\n                0, // LFO_WAVEFORM\n                69, // LFO_AMT\n                3, // LFO_FREQ\n                1, // LFO_FX_FREQ\n                1, // FX_FILTER\n                23, // FX_FREQ\n                167, // FX_RESONANCE\n                0, // FX_DIST\n                32, // FX_DRIVE\n                77, // FX_PAN_AMT\n                6, // FX_PAN_FREQ\n                25, // FX_DELAY_AMT\n                6 // FX_DELAY_TIME\n                ],\n                // Patterns\n                p: [],\n                // Columns\n                c: [\n                ]\n              },\n              { // Instrument 1\n                i: [\n                0, // OSC1_WAVEFORM\n                255, // OSC1_VOL\n                117, // OSC1_SEMI\n                64, // OSC1_XENV\n                0, // OSC2_WAVEFORM\n                255, // OSC2_VOL\n                110, // OSC2_SEMI\n                0, // OSC2_DETUNE\n                64, // OSC2_XENV\n                0, // NOISE_VOL\n                4, // ENV_ATTACK\n                6, // ENV_SUSTAIN\n                35, // ENV_RELEASE\n                0, // ENV_EXP_DECAY\n                0, // ARP_CHORD\n                0, // ARP_SPEED\n                0, // LFO_WAVEFORM\n                0, // LFO_AMT\n                0, // LFO_FREQ\n                0, // LFO_FX_FREQ\n                2, // FX_FILTER\n                14, // FX_FREQ\n                0, // FX_RESONANCE\n                1, // FX_DIST\n                39, // FX_DRIVE\n                76, // FX_PAN_AMT\n                5, // FX_PAN_FREQ\n                0, // FX_DELAY_AMT\n                0 // FX_DELAY_TIME\n                ],\n                // Patterns\n                p: [],\n                // Columns\n                c: [\n                ]\n              },\n              { // Instrument 2\n                i: [\n                0, // OSC1_WAVEFORM\n                255, // OSC1_VOL\n                116, // OSC1_SEMI\n                79, // OSC1_XENV\n                0, // OSC2_WAVEFORM\n                255, // OSC2_VOL\n                116, // OSC2_SEMI\n                0, // OSC2_DETUNE\n                83, // OSC2_XENV\n                0, // NOISE_VOL\n                4, // ENV_ATTACK\n                6, // ENV_SUSTAIN\n                69, // ENV_RELEASE\n                52, // ENV_EXP_DECAY\n                0, // ARP_CHORD\n                0, // ARP_SPEED\n                0, // LFO_WAVEFORM\n                0, // LFO_AMT\n                0, // LFO_FREQ\n                0, // LFO_FX_FREQ\n                2, // FX_FILTER\n                14, // FX_FREQ\n                0, // FX_RESONANCE\n                0, // FX_DIST\n                32, // FX_DRIVE\n                0, // FX_PAN_AMT\n                0, // FX_PAN_FREQ\n                0, // FX_DELAY_AMT\n                0 // FX_DELAY_TIME\n                ],\n                // Patterns\n                p: [4,4,4,4],\n                // Columns\n                c: [\n                  {n: [],\n                   f: []},\n                  {n: [],\n                   f: []},\n                  {n: [],\n                   f: []},\n                  {n: [135,,,135,,,,,,140,,140,,,,,135,,,135,,,,,,140,,140],\n                   f: []}\n                ]\n              },\n              { // Instrument 3\n                i: [\n                0, // OSC1_WAVEFORM\n                192, // OSC1_VOL\n                104, // OSC1_SEMI\n                64, // OSC1_XENV\n                0, // OSC2_WAVEFORM\n                80, // OSC2_VOL\n                99, // OSC2_SEMI\n                0, // OSC2_DETUNE\n                0, // OSC2_XENV\n                0, // NOISE_VOL\n                4, // ENV_ATTACK\n                0, // ENV_SUSTAIN\n                66, // ENV_RELEASE\n                0, // ENV_EXP_DECAY\n                0, // ARP_CHORD\n                0, // ARP_SPEED\n                3, // LFO_WAVEFORM\n                0, // LFO_AMT\n                0, // LFO_FREQ\n                0, // LFO_FX_FREQ\n                1, // FX_FILTER\n                0, // FX_FREQ\n                1, // FX_RESONANCE\n                2, // FX_DIST\n                32, // FX_DRIVE\n                37, // FX_PAN_AMT\n                4, // FX_PAN_FREQ\n                0, // FX_DELAY_AMT\n                0 // FX_DELAY_TIME\n                ],\n                // Patterns\n                p: [5,5,3,5],\n                // Columns\n                c: [\n                  {n: [],\n                   f: []},\n                  {n: [],\n                   f: []},\n                  {n: [,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,135,,,,,,153,,,,,153,153,,153,153,,153,152,163,,163,,160,,161,,159,,159],\n                   f: []},\n                  {n: [],\n                   f: []},\n                  {n: [,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,135,,,,,,153,,,,,,,149,,,135,137,,,,,153],\n                   f: []}\n                ]\n              },\n              { // Instrument 4\n                i: [\n                2, // OSC1_WAVEFORM\n                192, // OSC1_VOL\n                128, // OSC1_SEMI\n                0, // OSC1_XENV\n                2, // OSC2_WAVEFORM\n                192, // OSC2_VOL\n                140, // OSC2_SEMI\n                18, // OSC2_DETUNE\n                0, // OSC2_XENV\n                0, // NOISE_VOL\n                107, // ENV_ATTACK\n                115, // ENV_SUSTAIN\n                138, // ENV_RELEASE\n                0, // ENV_EXP_DECAY\n                0, // ARP_CHORD\n                0, // ARP_SPEED\n                0, // LFO_WAVEFORM\n                136, // LFO_AMT\n                5, // LFO_FREQ\n                1, // LFO_FX_FREQ\n                2, // FX_FILTER\n                8, // FX_FREQ\n                92, // FX_RESONANCE\n                21, // FX_DIST\n                32, // FX_DRIVE\n                148, // FX_PAN_AMT\n                5, // FX_PAN_FREQ\n                85, // FX_DELAY_AMT\n                8 // FX_DELAY_TIME\n                ],\n                // Patterns\n                p: [7,6,7],\n                // Columns\n                c: [\n                  {n: [],\n                   f: []},\n                  {n: [],\n                   f: []},\n                  {n: [],\n                   f: []},\n                  {n: [],\n                   f: []},\n                  {n: [],\n                   f: []},\n                  {n: [123,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,141,,,,,,,,,,,,,,,,,,,,,,,,142,,,,,,,,,,,,,,,,,,,,,,,,123],\n                   f: []},\n                  {n: [123,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,126,,,,,,,,,,,,,,,,,,,,,,,,142,,,,,,,,,,,,,,,,,,,,,,,,123],\n                   f: []}\n                ]\n              },\n            ],\n            rowLen: 6820,   // In sample lengths\n            patternLen: 32,  // Rows per pattern\n            endPattern: 3,  // End pattern\n            numChannels: 5  // Number of channels\n          };\n\n    const Audio = {\n        init() {\n            Audio.readyToPlay = false;\n\n            Audio.ctx = zzfxX;\n            Audio.gain_ = Audio.ctx.createGain();\n            Audio.gain_.connect(Audio.ctx.destination);\n            zzfx.destination_ = Audio.gain_;\n\n            Audio.shellReload = [,,68,0.01,,0.14,1,1.53,7.5,0.1,50,0.02,-0.01,-0.2,0.1,0.2,,0.47,0.01];\n            Audio.damage = [,,391,,.19,.01,2,.54,-4,20,,,,,,,.02,.9];\n            Audio.alarm = [,,970,.12,.25,.35,,.39,8.1,,10,.1,.2,,.1,,,.6,.09,.13];\n            // [,,961,.05,.06,1.17,1,4.67,.8,,,,,.8,-0.8,.1,.49,.62,.09];\n            Audio.victory = [,,454,.06,.86,.71,2,.63,-0.7,1.7,-83,.09,.27,.3,.2,,.18,.95,.02,.02];\n            //Audio.song = zzfxM(...ObliqueMystique);\n\n            Audio.mothDeath = [1.04,,363,.01,.08,.52,2,.31,.3,,,,,1.5,,.9,,.34,.07];\n            Audio.towerShoot = [1.56,,225,,.05,,3,.79,-7.6,.2,,,.08,,2.1,,.07,.99];\n            Audio.ghostDeath = [1.35,,968,.01,.02,,2,.12,-0.7,.1,-105,.06,,.1,,,.01,.66,.04];\n\n            Audio.buildingFinished = [2.03,0,65.40639,.03,.66,.18,2,.95,,,,,.3,.4,,,.19,.21,.1,.04];\n\n            Audio.waveCountdown = [1.56,0,261.6256,,.13,.3,,.41,,,,,,.2,,,.05,.2,.19,.22];\n            // Save our background music in os13k, for fun!\n            //localStorage[`OS13kMusic,${TITLE} - Oblique Mystique`] = JSON.stringify(ObliqueMystique);\n\n            this.player = new CPlayer();\n            this.player.init(song);\n            while (this.player.generate() !== 1) {\n                console.log('generating');\n            }\n\n            let buffer = this.player.createAudioBuffer(Audio.ctx);\n            this.songSource = Audio.ctx.createBufferSource();\n            this.songSource.buffer = buffer;\n            this.songSource.connect(Audio.gain_);\n        },\n\n        update() {\n            if (!Audio.readyToPlay) return;\n\n            if (!Audio.musicPlaying) {\n                //Audio.bgmusicnode = zzfxP(...Audio.song);\n                //Audio.bgmusicnode.loop = true;\n                this.songSource.start();\n                Audio.musicPlaying = true;\n            }\n        },\n\n        play(sound) {\n            if (!Audio.readyToPlay) return;\n            zzfx(...sound);\n        },\n\n        // It's important we do pausing and unpausing as specific events and not in general update(),\n        // because update() is triggered by the animation frame trigger which does not run if the\n        // page is not visible. (So, if you want the music to fade in the background, for example,\n        // that's not helpful if it won't work because you aren't looking at the page!)\n\n        pause() {\n            Audio.gain_.gain.linearRampToValueAtTime(0, Audio.ctx.currentTime + 1);\n        },\n\n        unpause() {\n            Audio.gain_.gain.linearRampToValueAtTime(1, Audio.ctx.currentTime + 1);\n        }\n    };\n\n    // MouseAdapter\n\n    /**\n     * MouseAdapter\n     *\n     * Maps mouse inputs to game inputs.\n     */\n    const MouseAdapter = {\n        init() {\n            this.map = [];\n            this.map[0] = Input.Action.RAW_TOUCH; // LMB\n            this.map[2] = Input.Action.RELOAD; // RMB\n\n            this.held = [];\n\n            window.addEventListener('mousemove', event => {\n                if (!this.pointer) this.pointer = {};\n                this.pointer.u = ((event.clientX * Viewport.width) / Viewport.clientWidth) | 0;\n                this.pointer.v = ((event.clientY * Viewport.height) / Viewport.clientHeight) | 0;\n                Input.mode = INPUT_MODE_MOUSE;\n            });\n\n            window.addEventListener('mouseout', () => {\n                this.pointer = undefined;\n            });\n\n            window.addEventListener('mousedown', event => {\n                let k = this.map[event.button];\n                if (k) this.held[k] = true;\n\n                // Hack to ensure we initialize audio after user interacts with game\n                Audio.readyToPlay = true;\n                game.frogger = 'mousedown';\n                Input.mode = INPUT_MODE_MOUSE;\n\n                this.pointerDragStart = {\n                    u: ((event.clientX * Viewport.width) / Viewport.clientWidth) | 0,\n                    v: ((event.clientY * Viewport.height) / Viewport.clientHeight) | 0\n                };\n            });\n\n            window.addEventListener('mouseup', event => {\n                let k = this.map[event.button];\n                if (k) this.held[k] = false;\n                game.frogger = 'mouseup';\n                Input.mode = INPUT_MODE_MOUSE;\n            });\n\n            window.addEventListener('click', event => {\n                event.preventDefault();\n                game.frogger = 'click';\n            });\n\n            window.addEventListener('contextmenu', event => {\n                let k = this.map[event.button];\n                if (k) this.held[k] = true;\n                this.releaseRMBTick = 2;\n                event.preventDefault();\n            });\n\n            MouseAdapter.reset();\n        },\n\n        update() {\n            // Hacks: ideally we could use mousedown and mouseup for all clicks and preventDefault to\n            // avoid opening the browser's context menu. This hasn't worked for me so far when clicking\n            // on a canvas, so I need to use the context menu event to capture a right mouse click instead.\n            //\n            // We fake a down/up for RMB clicks, which means we can't determine how long the RMB is held\n            // (but luckily we don't need to for this game).\n            if (this.releaseRMBTick) {\n                this.releaseRMBTick--;\n                if (this.releaseRMBTick === 0) {\n                    this.held[Input.Action.RELOAD] = false;\n                }\n            }\n        },\n\n        reset() {\n            this.pointer = undefined;\n            for (let action of Object.values(Input.Action)) {\n                this.held[action] = false;\n            }\n        }\n    };\n\n    // TouchAdapter\n\n    /**\n     * TouchAdapter\n     *\n     * Maps touch inputs to game inputs.\n     */\n    const TouchAdapter = {\n        init() {\n            this.map = [];\n            this.map[0] = Input.Action.RAW_TOUCH;\n\n            this.held = [];\n\n            window.addEventListener('touchmove', event => {\n                if (!this.pointer) this.pointer = {};\n                let p = event.changedTouches[0];\n                this.pointer.u = ((p.clientX * Viewport.width) / Viewport.clientWidth) | 0;\n                this.pointer.v = ((p.clientY * Viewport.height) / Viewport.clientHeight) | 0;\n                Input.mode = INPUT_MODE_TOUCH;\n            });\n\n            window.addEventListener('touchstart', event => {\n                let k = this.map[0];\n                if (k) this.held[k] = true;\n\n                // Hack to ensure we initialize audio after user interacts with game\n                Audio.readyToPlay = true;\n                game.frogger = 'TOUCHSTART';\n                Input.mode = INPUT_MODE_TOUCH;\n\n                let p = event.changedTouches[0];\n                this.pointerDragStart = {\n                    u: ((p.clientX * Viewport.width) / Viewport.clientWidth) | 0,\n                    v: ((p.clientY * Viewport.height) / Viewport.clientHeight) | 0\n                };\n                this.pointer = { ...this.pointerDragStart };\n            });\n\n            window.addEventListener('touchend', event => {\n                let k = this.map[0];\n                if (k) this.held[k] = false;\n                game.frogger = 'TOUCHEND';\n                Input.mode = INPUT_MODE_TOUCH;\n            });\n\n            this.reset();\n        },\n\n        update() {\n        },\n\n        reset() {\n            this.pointer = undefined;\n            for (let action of Object.values(Input.Action)) {\n                this.held[action] = false;\n            }\n        }\n    };\n\n    // Input\n\n    /**\n     * This is our abstract game input handler.\n     *\n     * Each frame, we'll collect input data from all of our supported input adapters,\n     * and turn it into game input. This game input can then be used by the game\n     * update for the frame.\n     *\n     * The input adapters give us data like \"key X pressed\", or \"right mouse button\n     * clicked\", or \"button B\" pressed, and these are translated into a game input\n     * like \"dodge\".\n     */\n    const Input = {\n        // Game Inputs\n        //\n        // Note that moving the player around is actually not considered an action; it's\n        // a separate non-action input called \"direction\". It just so happens that on\n        // keyboard, for example, pressing the \"down arrow\" key is considered both a\n        // press of the in-game DOWN action and a directional input. It's up to the input\n        // consumer to decide which input is relevant (if any). For example, on a menu,\n        // we may consume the DOWN/UP actions to navigate the menu, but ignore directional\n        // inputs.\n        //\n        Action: {\n            UP: 11,\n            DOWN: 12,\n            LEFT: 13,\n            RIGHT: 14,\n            ATTACK: 21,\n            RELOAD: 30,\n            MENU: 96,\n            MUTE: 97,\n            FREEZE: 98,\n            RAW_TOUCH: 40,\n            DRAG: 41,\n            TAP: 42\n        },\n\n        init() {\n            // A vector representing the direction the user is pressing/facing,\n            // separate from pressing and releasing inputs. Treating \"direction\"\n            // separately makes it easier to handle gamepad sticks.\n            this.direction = { x: 0, y: 0, m: 0 };\n\n            // \"Pressed\" means an input was pressed THIS FRAME.\n            this.pressed = {};\n\n            // \"Released\" means an input was released THIS FRAME.\n            this.released = {};\n\n            // \"Held\" means an input is held down. The input was \"Pressed\" either\n            // this frame or in a past frame, and has not been \"Released\" yet.\n            this.held = {};\n\n            // How many frames was this input held down by the player. If [held]\n            // is false, it represents how long the input was last held down.\n            this.framesHeld = {};\n\n            KeyboardAdapter.init();\n            MouseAdapter.init();\n            TouchAdapter.init();\n\n            this.mode = INPUT_MODE_TOUCH;\n\n            this.dragging = false;\n        },\n\n        update() {\n            // We could have some kind of \"input adapter toggle\", but it's easier to just treat all inputs\n            // as valid -- if you're pressing the \"attack\" button on either gamepad or keyboard, then you're\n            // attacking. For directional input, we instead check whether there's movement on the thumbstick,\n            // and we use it if there is -- otherwise we try to extract movement from the keyboard instead.\n\n            KeyboardAdapter.update();\n\n            let pointerAdapter = this.mode === INPUT_MODE_MOUSE ? MouseAdapter : TouchAdapter;\n\n            for (let action of Object.values(Input.Action)) {\n                let held = pointerAdapter.held[action] || KeyboardAdapter.held[action];\n                this.pressed[action] = !this.held[action] && held;\n                this.released[action] = this.held[action] && !held;\n\n                if (this.pressed[action]) {\n                    this.framesHeld[action] = 1;\n                } else if (this.held[action] && held) {\n                    this.framesHeld[action]++;\n                }\n\n                this.held[action] = held;\n            }\n\n            this.pointer = pointerAdapter.pointer;\n            this.direction = KeyboardAdapter.direction;\n            //this.direction = this.gamepad.direction.m > 0 ? this.gamepad.direction : this.keyboard.direction;\n\n            if (this.held[Input.Action.RAW_TOUCH]) {\n                if (this.framesHeld[Input.Action.RAW_TOUCH] > 20) {\n                    this.dragging = true;\n                }\n\n                let diffPixels = Math.abs(pointerAdapter.pointerDragStart.u - pointerAdapter.pointer.u) + Math.abs(pointerAdapter.pointerDragStart.v - pointerAdapter.pointer.v);\n                if (diffPixels > 5) {\n                    this.dragging = true;\n                }\n            }\n\n            if (this.dragging && pointerAdapter.pointer) {\n                this.dragVector = {\n                    x: pointerAdapter.pointer.u - pointerAdapter.pointerDragStart.u,\n                    y: pointerAdapter.pointer.v - pointerAdapter.pointerDragStart.v\n                };\n            }\n\n            if (this.released[Input.Action.RAW_TOUCH]) {\n                if (this.dragging) {\n                    this.dragging = false;\n                } else {\n                    this.pressed[Input.Action.TAP] = true;\n                    this.framesHeld[Input.Action.TAP] = 1;\n                }\n            }\n        },\n\n        onDown(action) {},\n        onUp(action) {},\n    };\n\n    const C_WIDTH = 3;\n    const C_HEIGHT = 5;\n\n    // Very simple variable-width font implementation. The characters in the font strip\n    // are left-aligned in their 3x5 pixel boxes, so in order to have variable width,\n    // we just need to note the characters that AREN'T full width. Anything not in\n    // this list has full shift (3+1 = 4 pixels).\n    const C_SHIFT = {\n        10: 0, // LF (\\n)\n        32: 3, // Space ( )\n        33: 3, // Bang (!)\n        39: 2, // Apostrophe (')\n        44: 3, // Comma (,)\n        46: 3, // Period (.)\n        73: 2 // I\n    };\n\n    const C_ICONS = {};\n\n    /**\n     * Text\n     *\n     * Utilities for drawing text using in-game pixel font.\n     */\n    const Text = {\n        init() {\n            Text.white = Sprite.font.img;\n\n            let icons = [\n                [101, Sprite.buildings[2]],      // e = Earth\n                //[108, Sprite.icon_mouse_lmb],  // l\n                //[114, Sprite.icon_mouse_rmb],  // r\n            ];\n            for (let icon of icons) {\n                C_ICONS[icon[0]] = icon[1];\n                C_SHIFT[icon[0]] = icon[1].img.width + 1;\n            }\n\n            Text.black = recolor(Text.white, rgba(0, 0, 0, 1));\n            Text.black_shadow = recolor(Text.white, rgba(90, 20, 90, 0.15));\n            Text.blue = recolor(Text.white, rgba(200, 40, 220, 1));\n            Text.blue_shadow = recolor(Text.white, rgba(240, 50, 200, 0.2));\n            Text.shadow = recolor(Text.white, rgba(240, 240, 255, 0.25));\n            Text.red = recolor(Text.white, rgba(240, 50, 50, 1));\n\n            Text.duotone = recolorDuotone(Text.white, '#ffaa5e', '#ffd4a3');\n            Text.duotone_red = recolorDuotone(Text.white, '#ffaa5e', '#ffd4a3', rgba(255, 0, 0, 0.7));\n        },\n\n        drawText(ctx, text, u, v, scale = 1, font = Text.duotone, shadow) {\n            for (let idx = 0; idx < text.length; idx++) {\n                let c = text.charCodeAt(idx);\n                if (c === 119) {\n                    // w\n                    font = Text.duotone;\n                    continue;\n                } else if (c === 114) {\n                    // r\n                    font = Text.duotone_red;\n                    continue;\n                }\n\n                if (C_ICONS[c]) {\n                    ctx.drawImage(\n                        C_ICONS[c].img,\n                        u,\n                        v - (C_ICONS[c].img.height + 4) / 2\n                    );\n                } else {\n                    let k = (c - 32) * (C_WIDTH + 1);\n                    if (shadow) {\n                        ctx.drawImage(\n                            shadow,\n                            k % 180,\n                            (k / 180 | 0) * 6,\n                            C_WIDTH,\n                            C_HEIGHT,\n                            u + 1,\n                            v + 1,\n                            C_WIDTH * scale,\n                            C_HEIGHT * scale\n                        );\n                    }\n                    ctx.drawImage(\n                        font,\n                        k % 180,\n                        (k / 180 | 0) * 6,\n                        C_WIDTH,\n                        C_HEIGHT,\n                        u,\n                        v,\n                        C_WIDTH * scale,\n                        C_HEIGHT * scale\n                    );\n                }\n                u += (C_SHIFT[c] || C_WIDTH + 1) * scale;\n            }\n        },\n\n        /*\n        drawRightText(ctx, text, u, v, scale = 1, font = Text.white, shadow) {\n            u -= Text.measureWidth(text, scale);\n            Text.drawText(ctx, text, u, v, scale, font, shadow);\n        },\n        */\n\n        drawParagraph(ctx, text, u, v, w, h, scale = 1, font = Text.duotone, shadow) {\n            let cu = u,\n                cv = v,\n                phrases = text.split(' ');\n\n            for (let phrase of phrases) {\n                while (phrase[0] === '\\n') {\n                    phrase = phrase.slice(1);\n                    cu = u;\n                    cv += (C_HEIGHT + 1) * scale;\n                }\n                let phraseWidth = Text.measureWidth(phrase, scale);\n                if (cu + phraseWidth - u > w) {\n                    cu = u;\n                    cv += (C_HEIGHT + 1) * scale;\n                }\n                Text.drawText(ctx, phrase, cu, cv, scale, font, shadow);\n                cu += phraseWidth + (C_SHIFT[32] || 4);\n            }\n        },\n\n        measureWidth(text, scale) {\n            return text.split('').reduce((sum, c) => sum + (C_SHIFT[c.charCodeAt(0)] || 4), 0) * scale;\n        }\n    };\n\n    // Text utility functions\n\n\n    function recolor(font, color) {\n        let canvas = createCanvas(font.width, font.height);\n        canvas.ctx.fillStyle = color;\n        canvas.ctx.fillRect(0, 0, font.width, font.height);\n        canvas.ctx.globalCompositeOperation = 'destination-in';\n        canvas.ctx.drawImage(font, 0, 0);\n        return canvas.canvas;\n    }\n\n    function recolorDuotone(font, topColor, bottomColor, tint) {\n        // Note: shortcut assumes that the font image is exactly 2 rows of characters.\n        let canvas = createCanvas(font.width, font.height);\n        canvas.ctx.fillStyle = bottomColor;\n        canvas.ctx.fillRect(0, 0, font.width, font.height);\n        canvas.ctx.fillStyle = topColor;\n        canvas.ctx.fillRect(0, 0, font.width, 1);\n        canvas.ctx.fillRect(0, C_HEIGHT + 1, font.width, 1);\n        if (tint) {\n            canvas.ctx.fillStyle = tint;\n            canvas.ctx.fillRect(0, 0, font.width, font.height);\n        }\n        canvas.ctx.globalCompositeOperation = 'destination-in';\n        canvas.ctx.drawImage(font, 0, 0);\n        return canvas.canvas;\n    }\n\n    // https://jonny.morrill.me/en/blog/gamedev-how-to-implement-a-camera-shake-effect/\n\n    /**\n     * Shake it baby.\n     */\n    class ScreenShake {\n        constructor(frames, hAmplitude, vAmplitude) {\n            this.frames = frames;\n            this.hAmplitude = hAmplitude;\n            this.vAmplitude = vAmplitude;\n            this.hSamples = [];\n            this.vSamples = [];\n\n            var sampleCount = frames / 2;\n            for (let i = 0; i < sampleCount; i++) {\n                this.hSamples.push(Math.random() * 2 - 1);\n                this.vSamples.push(Math.random() * 2 - 1);\n            }\n            this.frame = -1;\n        }\n\n        update() {\n            this.frame++;\n            if (this.frame >= this.frames) {\n                return false;\n            }\n\n            //let s = (this.frames / 10) * (this.frame / this.frames);\n            let s = this.frame / 2;\n            let s0 = s | 0;\n            let s1 = s0 + 1;\n            let decay = 1 - this.frame / this.frames;\n\n            this.x =\n                this.hAmplitude *\n                decay *\n                (this.hSamples[s0] +\n                    (s - s0) * (this.hSamples[s1] - this.hSamples[s0]));\n            this.y =\n                this.vAmplitude *\n                decay *\n                (this.vSamples[s0] +\n                    (s - s0) * (this.vSamples[s1] - this.vSamples[s0]));\n\n            return true;\n        }\n    }\n\n    class Gore {\n        constructor(pos, angle, f) {\n            this.pos = { ...pos };\n            this.angle = angle;\n            this.vel = vector2point(angle2vector(this.angle, f ? 8 : 5));\n            this.a = R45;\n            this.noClipEntity = true;\n            this.f = f;\n            this.bounce = true;\n            this.radius = 1;\n            this.r = 0;\n            this.t = -1;\n            this.d = this.f === 0 ? 45 : 70;\n\n            // TEMPORARY\n            this.noClipWall = true;\n        }\n\n        think() {\n            if (++this.t === this.d) this.cull = true;\n            this.vel.x *= 0.9;\n            this.vel.y *= 0.9;\n            this.a *= 0.95;\n            this.r += this.a;\n        }\n\n        draw() {\n            Sprite.drawViewportSprite(\n                Sprite.gore[this.f],\n                this.pos,\n                this.r\n            );\n        }\n    }\n\n    Gore.damage = entity => Gore.spray(entity, 8, () => 0);\n    Gore.kill = entity => Gore.spray(entity, 16, () => (Math.random() * 4) | 0);\n    Gore.spray = (entity, count, cb) => {\n        let angle = entity.lastDamage ? vector2angle(entity.lastDamage.vector) : Math.random() * R360;\n\n        for (let i = 0; i < count * (game.victory ? 2 : 1); i++) {\n            let r = Math.random() * entity.radius,\n                p = vectorAdd(entity.pos, angle2vector(Math.random() * R360, r));\n            game.entities.push(\n                new Gore(p, angle + Math.random() * R90 - R45, cb())\n            );\n        }\n    };\n\n    // WorldData\n    //\n    // This file is generated by `gulp buildAssets`.\n\n    const WorldData =\n    /* <generated-data> */\n    {\n        \"floors\": [\n            {\n                \"name\": \"1F\",\n                \"tiles\": [\n                    [\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        14,\n                        14,\n                        14,\n                        14,\n                        14,\n                        14,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        14,\n                        14,\n                        14,\n                        14,\n                        14,\n                        0,\n                        0,\n                        0\n                    ],\n                    [\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        14,\n                        14,\n                        14,\n                        1,\n                        1,\n                        1,\n                        1,\n                        14,\n                        14,\n                        14,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        14,\n                        14,\n                        1,\n                        1,\n                        1,\n                        14,\n                        14,\n                        0,\n                        0\n                    ],\n                    [\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        14,\n                        14,\n                        14,\n                        14,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        14,\n                        14,\n                        0,\n                        0,\n                        14,\n                        14,\n                        14,\n                        3,\n                        1,\n                        1,\n                        1,\n                        1,\n                        14,\n                        14,\n                        0\n                    ],\n                    [\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        14,\n                        14,\n                        14,\n                        14,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        7,\n                        7,\n                        1,\n                        1,\n                        1,\n                        1,\n                        14,\n                        14,\n                        14,\n                        14,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        14,\n                        0\n                    ],\n                    [\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        14,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        7,\n                        8,\n                        8,\n                        7,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        2,\n                        14,\n                        0\n                    ],\n                    [\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        14,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        8,\n                        8,\n                        1,\n                        1,\n                        1,\n                        1,\n                        3,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        14,\n                        14,\n                        0\n                    ],\n                    [\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        14,\n                        14,\n                        14,\n                        14,\n                        14,\n                        14,\n                        1,\n                        3,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        3,\n                        1,\n                        1,\n                        1,\n                        14,\n                        14,\n                        14,\n                        0,\n                        0\n                    ],\n                    [\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        14,\n                        14,\n                        14,\n                        14,\n                        14,\n                        14,\n                        14,\n                        1,\n                        1,\n                        1,\n                        14,\n                        14,\n                        14,\n                        1,\n                        1,\n                        2,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        2,\n                        1,\n                        1,\n                        1,\n                        14,\n                        14,\n                        0,\n                        0,\n                        0,\n                        0\n                    ],\n                    [\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        14,\n                        14,\n                        3,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        14,\n                        14,\n                        14,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        14,\n                        14,\n                        14,\n                        14,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        14,\n                        14,\n                        14,\n                        14,\n                        0\n                    ],\n                    [\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        14,\n                        14,\n                        1,\n                        1,\n                        1,\n                        1,\n                        2,\n                        1,\n                        1,\n                        1,\n                        7,\n                        1,\n                        1,\n                        1,\n                        14,\n                        14,\n                        14,\n                        1,\n                        1,\n                        1,\n                        1,\n                        14,\n                        14,\n                        14,\n                        14,\n                        14,\n                        1,\n                        14,\n                        14,\n                        2,\n                        1,\n                        3,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        14,\n                        14\n                    ],\n                    [\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        14,\n                        1,\n                        1,\n                        7,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        14,\n                        1,\n                        1,\n                        1,\n                        1,\n                        14,\n                        3,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        14\n                    ],\n                    [\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        14,\n                        1,\n                        7,\n                        8,\n                        1,\n                        1,\n                        14,\n                        14,\n                        14,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        7,\n                        1,\n                        14,\n                        1,\n                        1,\n                        1,\n                        1,\n                        14,\n                        14,\n                        1,\n                        1,\n                        1,\n                        1,\n                        3,\n                        14\n                    ],\n                    [\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        14,\n                        1,\n                        1,\n                        1,\n                        1,\n                        14,\n                        14,\n                        0,\n                        14,\n                        14,\n                        1,\n                        1,\n                        1,\n                        2,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        7,\n                        1,\n                        1,\n                        1,\n                        14,\n                        1,\n                        7,\n                        1,\n                        14,\n                        14,\n                        14,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        14\n                    ],\n                    [\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        14,\n                        14,\n                        1,\n                        2,\n                        14,\n                        14,\n                        0,\n                        0,\n                        14,\n                        14,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        14,\n                        14,\n                        14,\n                        14,\n                        1,\n                        1,\n                        2,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        14,\n                        14,\n                        1,\n                        8,\n                        1,\n                        14,\n                        0,\n                        14,\n                        14,\n                        1,\n                        1,\n                        2,\n                        14,\n                        14\n                    ],\n                    [\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        14,\n                        14,\n                        14,\n                        14,\n                        0,\n                        0,\n                        14,\n                        14,\n                        1,\n                        1,\n                        1,\n                        3,\n                        1,\n                        14,\n                        14,\n                        0,\n                        0,\n                        14,\n                        14,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        14,\n                        14,\n                        14,\n                        1,\n                        8,\n                        1,\n                        14,\n                        0,\n                        0,\n                        14,\n                        14,\n                        14,\n                        14,\n                        14,\n                        0\n                    ],\n                    [\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        14,\n                        1,\n                        1,\n                        7,\n                        1,\n                        1,\n                        1,\n                        14,\n                        0,\n                        0,\n                        0,\n                        0,\n                        14,\n                        14,\n                        1,\n                        1,\n                        1,\n                        1,\n                        2,\n                        14,\n                        14,\n                        14,\n                        1,\n                        8,\n                        1,\n                        14,\n                        14,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0\n                    ],\n                    [\n                        0,\n                        0,\n                        0,\n                        14,\n                        14,\n                        14,\n                        14,\n                        14,\n                        14,\n                        14,\n                        14,\n                        14,\n                        14,\n                        1,\n                        1,\n                        1,\n                        1,\n                        14,\n                        14,\n                        14,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        14,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        14,\n                        1,\n                        1,\n                        1,\n                        1,\n                        2,\n                        14,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0\n                    ],\n                    [\n                        0,\n                        14,\n                        14,\n                        14,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        14,\n                        14,\n                        14,\n                        14,\n                        1,\n                        1,\n                        1,\n                        1,\n                        14,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        14,\n                        14,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        14,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        14,\n                        14,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0\n                    ],\n                    [\n                        0,\n                        14,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        2,\n                        14,\n                        14,\n                        14,\n                        1,\n                        1,\n                        1,\n                        1,\n                        14,\n                        14,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        14,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        14,\n                        14,\n                        14,\n                        1,\n                        1,\n                        1,\n                        1,\n                        14,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0\n                    ],\n                    [\n                        14,\n                        14,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        14,\n                        14,\n                        14,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        14,\n                        14,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        14,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        14,\n                        14,\n                        1,\n                        1,\n                        1,\n                        14,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0\n                    ],\n                    [\n                        14,\n                        1,\n                        1,\n                        1,\n                        1,\n                        14,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        14,\n                        14,\n                        14,\n                        1,\n                        1,\n                        2,\n                        1,\n                        14,\n                        14,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        14,\n                        1,\n                        2,\n                        1,\n                        1,\n                        7,\n                        1,\n                        1,\n                        1,\n                        14,\n                        1,\n                        7,\n                        1,\n                        14,\n                        14,\n                        14,\n                        14,\n                        14,\n                        0,\n                        0\n                    ],\n                    [\n                        14,\n                        1,\n                        7,\n                        1,\n                        1,\n                        14,\n                        14,\n                        1,\n                        1,\n                        1,\n                        1,\n                        14,\n                        14,\n                        14,\n                        14,\n                        1,\n                        1,\n                        1,\n                        14,\n                        14,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        14,\n                        14,\n                        1,\n                        1,\n                        1,\n                        8,\n                        7,\n                        1,\n                        1,\n                        14,\n                        1,\n                        1,\n                        1,\n                        14,\n                        14,\n                        1,\n                        1,\n                        14,\n                        14,\n                        0\n                    ],\n                    [\n                        14,\n                        1,\n                        1,\n                        1,\n                        1,\n                        14,\n                        14,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        14,\n                        14,\n                        14,\n                        1,\n                        1,\n                        1,\n                        1,\n                        14,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        14,\n                        14,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        14,\n                        14,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        14,\n                        0\n                    ],\n                    [\n                        14,\n                        14,\n                        1,\n                        1,\n                        1,\n                        14,\n                        14,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        14,\n                        14,\n                        1,\n                        1,\n                        7,\n                        1,\n                        14,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        14,\n                        14,\n                        1,\n                        1,\n                        3,\n                        1,\n                        14,\n                        14,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        14,\n                        0\n                    ],\n                    [\n                        0,\n                        14,\n                        1,\n                        1,\n                        1,\n                        14,\n                        14,\n                        14,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        14,\n                        14,\n                        1,\n                        1,\n                        8,\n                        1,\n                        14,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        14,\n                        14,\n                        14,\n                        14,\n                        14,\n                        14,\n                        1,\n                        1,\n                        1,\n                        3,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        14,\n                        0\n                    ],\n                    [\n                        0,\n                        14,\n                        1,\n                        1,\n                        1,\n                        1,\n                        14,\n                        14,\n                        14,\n                        1,\n                        1,\n                        1,\n                        14,\n                        14,\n                        14,\n                        1,\n                        1,\n                        1,\n                        1,\n                        14,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        14,\n                        14,\n                        1,\n                        1,\n                        1,\n                        1,\n                        14,\n                        14,\n                        14,\n                        1,\n                        1,\n                        1,\n                        14,\n                        14,\n                        0\n                    ],\n                    [\n                        0,\n                        14,\n                        1,\n                        1,\n                        1,\n                        1,\n                        2,\n                        14,\n                        14,\n                        14,\n                        14,\n                        14,\n                        14,\n                        14,\n                        1,\n                        1,\n                        1,\n                        1,\n                        14,\n                        14,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        14,\n                        14,\n                        1,\n                        1,\n                        1,\n                        2,\n                        1,\n                        14,\n                        0,\n                        14,\n                        14,\n                        14,\n                        14,\n                        14,\n                        0,\n                        0\n                    ],\n                    [\n                        0,\n                        14,\n                        14,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        14,\n                        14,\n                        14,\n                        14,\n                        14,\n                        2,\n                        1,\n                        1,\n                        1,\n                        14,\n                        14,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        14,\n                        1,\n                        3,\n                        1,\n                        14,\n                        14,\n                        14,\n                        14,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0\n                    ],\n                    [\n                        0,\n                        0,\n                        14,\n                        14,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        3,\n                        1,\n                        14,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        14,\n                        1,\n                        1,\n                        14,\n                        14,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0\n                    ],\n                    [\n                        0,\n                        0,\n                        0,\n                        14,\n                        14,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        7,\n                        1,\n                        1,\n                        1,\n                        1,\n                        14,\n                        14,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        14,\n                        14,\n                        14,\n                        14,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0\n                    ],\n                    [\n                        0,\n                        0,\n                        0,\n                        0,\n                        14,\n                        14,\n                        14,\n                        1,\n                        3,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        1,\n                        14,\n                        14,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0\n                    ],\n                    [\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        14,\n                        14,\n                        14,\n                        14,\n                        14,\n                        14,\n                        14,\n                        14,\n                        14,\n                        14,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0,\n                        0\n                    ]\n                ],\n                \"rooms\": [],\n                \"objects\": [\n                    {\n                        \"name\": \"SPAWN\",\n                        \"x\": 42,\n                        \"y\": 11\n                    },\n                    {\n                        \"name\": \"EARTH\",\n                        \"x\": 20,\n                        \"y\": 3\n                    },\n                    {\n                        \"name\": \"EXIT\",\n                        \"x\": 10,\n                        \"y\": 24\n                    },\n                    {\n                        \"name\": \"EARTH\",\n                        \"x\": 41,\n                        \"y\": 25\n                    },\n                    {\n                        \"name\": \"EARTH\",\n                        \"x\": 43,\n                        \"y\": 22\n                    },\n                    {\n                        \"name\": \"EARTH\",\n                        \"x\": 33,\n                        \"y\": 17\n                    },\n                    {\n                        \"name\": \"EARTH\",\n                        \"x\": 40,\n                        \"y\": 6\n                    },\n                    {\n                        \"name\": \"EARTH\",\n                        \"x\": 36,\n                        \"y\": 3\n                    },\n                    {\n                        \"name\": \"EARTH\",\n                        \"x\": 14,\n                        \"y\": 7\n                    },\n                    {\n                        \"name\": \"EARTH\",\n                        \"x\": 31,\n                        \"y\": 13\n                    },\n                    {\n                        \"name\": \"EARTH\",\n                        \"x\": 7,\n                        \"y\": 13\n                    }\n                ],\n                \"triggers\": [],\n                \"id\": 0\n            }\n        ],\n        \"bounds\": [\n            [\n                0,\n                0\n            ],\n            [\n                46,\n                32\n            ]\n        ],\n        \"spawn\": [\n            42,\n            11,\n            0\n        ]\n    }\n    /* </generated-data> */\n    ;\n\n    /**\n     * Monster\n     */\n    class Moth {\n        constructor(pos) {\n            this.pos = { ...pos };\n            this.target = { ...this.pos };\n            this.vel = { x: 0, y: 0 };\n            this.hp = 1;\n            this.damage = [];\n            this.radius = 3;\n            this.state = IDLE;\n            this.noClipEntity = true;\n            this.noClipWall = true;\n\n            this.lightlevel = 7;\n\n            this.tasks = [];\n            this.carrying = 0;\n\n            this.offset = { x: 0, y: 0 };\n\n            this.carryAmount = 0;\n            this.carryCapacity = 5_00;\n            this.carryPerFrame = 3;\n            this.transferAmount = 0;\n\n            this.frame = 0;\n            this.circleOffset = Math.floor(Math.random() * 16);\n\n            this.lastAssigned = game.frame;\n\n            let qr = xy2qr(this.pos);\n            this.moveTo({ q: qr.q, r: qr.r - 1 });\n        }\n\n        think() {\n            if (this.tasks.length === 0) {\n                this.tasks.push({ task: IDLE });\n            }\n            let task = this.tasks[this.tasks.length - 1];\n\n            this.frame = (Math.floor(game.frame / 8) % 2) + 1;\n\n            if (this.state === DEAD) {\n                Audio.play(Audio.mothDeath);\n                this.cull = true;\n                return;\n            }\n\n            if (task.task === MOVE) {\n                this.target = centerxy(qr2xy(task.qr));\n                let dist = vectorBetween(this.pos, this.target);\n\n                if (dist.m < ACTION_DISTANCE) {\n                    this.tasks.pop();\n                }\n            } else if (task.task === CONSTRUCT) {\n                this.target = centerxy(qr2xy(task.qr));\n                let dist = vectorBetween(this.pos, this.target);\n\n                if (dist.m < ACTION_DISTANCE) {\n                    this.frame = 0;\n                    let building = World.buildingAt(task.qr);\n                    building.buildFrames++;\n                    if (building.buildFrames >= building.buildFramesTotal) {\n                        this.tasks.pop();\n                    }\n                }\n            } else if (task.task === PICKUP) {\n                this.target = centerxy(qr2xy(task.qr));\n                let dist = vectorBetween(this.pos, this.target);\n\n                let building = World.buildingAt(task.qr);\n\n                if (!building) {\n                    this.tasks.pop();\n                    this.tasks.push({ task: DROPOFF, qr: { q: World.spawn.q, r: World.spawn.r } });\n                } else if (dist.m < ACTION_DISTANCE) {\n                    this.frame = 0;\n                    this.carryAmount += this.carryPerFrame;\n                    building.resourcesLeft -= this.carryPerFrame;\n                    if (this.carryAmount >= this.carryCapacity) {\n                        this.tasks.push({ task: DROPOFF, qr: { q: World.spawn.q, r: World.spawn.r } });\n                    }\n                }\n            } else if (task.task === DROPOFF) {\n                this.target = centerxy(qr2xy(task.qr));\n                let dist = vectorBetween(this.pos, this.target);\n\n                if (dist.m < ACTION_DISTANCE) {\n                    this.frame = 0;\n\n                    this.carryAmount -= this.carryPerFrame;\n                    this.transferAmount += this.carryPerFrame;\n                    if (this.transferAmount >= 100) {\n                        game.earth++;\n                        this.transferAmount -= 100;\n                    }\n\n                    if (this.carryAmount <= 0) {\n                        this.tasks.pop();\n                    }\n                }\n            }\n\n            let pathToTarget = World.pathToTarget(this.pos, this.target);\n            console.log([this.target, pathToTarget]);\n            let dist = vectorBetween(this.pos, pathToTarget);\n            dist.m = clamp(dist.m, 0, 0.5);\n\n            let newVelocity = vector2point(dist);\n\n            this.vel = {\n                x: (this.vel.x + newVelocity.x) / 2,\n                y: (this.vel.y + newVelocity.y) / 2\n            };\n        }\n\n        draw() {\n            let r = 3;\n            if (this.frame === 0) r--;\n\n            let uv = {\n                u: Math.cos((game.frame + this.circleOffset) / 16) * r,\n                v: Math.sin((game.frame + this.circleOffset) / 16) * 1\n            };\n\n            Sprite.drawViewportSprite(Sprite.moth[this.frame], { x: this.pos.x + uv.u, y: this.pos.y + uv.v });\n\n            //Sprite.drawViewportSprite(Sprite.spindoctor[0], this.pos, game.frame / 5);\n            //Sprite.drawViewportSprite(Sprite.spindoctor[1], this.pos);\n        }\n\n        gather(qr) {\n            //this.target = { x: qr.q * 8, y: qr.r * 8 };\n            this.tasks = [\n                { task: PICKUP, qr: qr }\n            ];\n            this.lastAssigned = game.frame;\n        }\n\n        construct(qr) {\n            //this.target = { x: qr.q * 8, y: qr.r * 8 };\n            this.tasks.push(\n                { task: CONSTRUCT, qr: qr }\n            );\n            this.lastAssigned = game.frame;\n        }\n\n        moveTo(qr) {\n            this.tasks = [\n                { task: MOVE, qr: qr }\n            ];\n            this.lastAssigned = game.frame;\n        }\n\n        isBusy() {\n            let task = this.tasks[this.tasks.length - 1];\n            return task && task.task !== IDLE;\n        }\n    }\n\n    Moth.sortMoths = () => {\n        let moths = game.entities.filter(e => e instanceof Moth);\n        moths.sort((a, b) => {\n            if (a.isBusy() && !b.isBusy()) {\n                return 1;\n            } else if (!a.isBusy() && b.isBusy()) {\n                return -1;\n            } else {\n                return a.lastAssigned - b.lastAssigned;\n            }\n        });\n        return moths;\n    };\n\n    Moth.assign = (fn) => {\n        let moths = Moth.sortMoths();\n\n        for (let i = 0; i < moths.length; i++) {\n            if (i > 0 && moths[i].isBusy()) break;\n            fn(moths[i]);\n        }\n    };\n\n    class TowerGunk {\n        constructor(pos, target, damage) {\n            this.pos = { ...pos };\n            this.target = target;\n            this.vel = { x: 0, y: 0 };\n            this.damage = damage || 70;\n        }\n\n        think() {\n            let diff = vectorBetween(this.pos, this.target.pos);\n            diff.m = clamp(diff.m, 0, 2);\n            this.vel = {\n                x: (this.vel.x + diff.x * diff.m) / 2,\n                y: (this.vel.y + diff.y * diff.m) / 2\n            };\n\n            if (diff.m < 1) {\n                this.target.damage.push({ amount: this.damage, vector: diff, knockback: 0 });\n                this.cull = true;\n                console.log('HIT');\n            }\n        }\n\n        draw() {\n            Sprite.drawViewportSprite(\n                Sprite.bullet1[0],\n                this.pos,\n                this.r\n            );\n        }\n    }\n\n    /**\n     * Monster\n     */\n    const BuildTowerAction = {\n        defaultTapAction() {\n            let building = World.buildingAt(World.selected);\n            return !!building;\n        },\n\n        buttonSprite() {\n            return Sprite.buttons[6];\n        },\n\n        buttonSelectedSprite() {\n            return Sprite.buttons[7];\n        },\n\n        drawSelectedText(u, v) {\n            let building = World.buildingAt(World.selected);\n            let cost = 15;\n            let text = game.canAfford(cost) ? 'BUILD TOWER \\ne' + cost : 'BUILD TOWER \\ner' + cost;\n\n            if (building) {\n                text = 'FINISH BUILDING';\n            }\n\n            Text.drawParagraph(\n                Viewport.ctx,\n                text,\n                u,\n                v\n            );\n        },\n\n        tap() {\n            let building = World.buildingAt(World.selected);\n            let cost = 15;\n\n            if (building) {\n                Moth.assign(moth => moth.construct(World.selected));\n            } else if (game.canAfford(cost)) {\n                game.payCost(cost);\n                World.buildings.push(new TowerBuilding(World.selected));\n                Moth.assign(moth => moth.construct(World.selected));\n                return true;\n            }\n        }\n    };\n\n    /**\n     * Monster\n     */\n    class TowerBuilding {\n        constructor(qr) {\n            this.qr = { ...qr };\n            this.framesToNextShot = 10;\n\n            this.lightlevel = 7;\n\n            this.state = WIP;\n            this.buildFrames = 0;\n            this.buildFramesTotal = 180;\n\n            this.title = 'TOWER';\n            this.portraitSprite = Sprite.buildings[0];\n        }\n\n        think() {\n            if (this.buildFrames >= this.buildFramesTotal) {\n                if (this.state !== ONLINE) {\n                    this.state = ONLINE;\n                    Audio.play(Audio.buildingFinished);\n                }\n            } else {\n                return;\n            }\n\n            let xy = centerxy(qr2xy(this.qr));\n\n            let closestTarget, closestVector;\n\n            if (!this.target || this.target.cull) {\n                for (let entity of game.entities) {\n                    if (!entity.enemy) continue;\n\n                    //let qr = xy2qr(entity.pos);\n                    let v = vectorBetween(xy, entity.pos);\n                    if (v.m < 32 && (!closestVector || v.m < closestVector.m)) {\n                        closestTarget = entity;\n                        closestVector = v;\n                    }\n                }\n\n                console.log('ATTEMPTED to pick target for building', closestTarget);\n                this.target = closestTarget;\n            }\n\n            if (this.framesToNextShot > 0) {\n                this.framesToNextShot--;\n            }\n\n            if (this.target && this.framesToNextShot === 0) {\n                vectorBetween(xy, this.target);\n                game.entities.push(new TowerGunk(xy, this.target));\n                this.framesToNextShot = 100;\n                Audio.play(Audio.towerShoot);\n            }\n        }\n\n        draw() {\n            let xy = qr2xy(this.qr);\n            xy2uv(centerxy(xy));\n\n            //Viewport.ctx.drawImage(Sprite.tiles[tiles[y][x] - 1].img, x * 8 + offset.u, y * 8 + offset.v);\n\n            Viewport.ctx.globalAlpha = this.state === WIP ? 0.5 : 1;\n            Sprite.drawViewportSprite(Sprite.buildings[0], xy);\n            Viewport.ctx.globalAlpha = 1;\n\n            /*\n            Viewport.ctx.fillStyle = 'rgba(255, 255, 255, 0.4)';\n            Viewport.ctx.beginPath();\n            Viewport.ctx.arc(uv.u, uv.v, 4, 0, 2 * Math.PI * 0.7);\n            Viewport.ctx.fill();\n            */\n\n            if (this.state === WIP) {\n                let progress = clamp(Math.floor(8 * this.buildFrames / this.buildFramesTotal), 0, 7);\n\n                Viewport.ctx.globalAlpha = 0.5;\n                Sprite.drawViewportSprite(Sprite.hud_wip[7], xy);\n                Viewport.ctx.globalAlpha = 1;\n                Sprite.drawViewportSprite(Sprite.hud_wip[progress], xy);\n            }\n\n            //Sprite.drawViewportSprite(Sprite.spindoctor[0], this.pos, game.frame / 5);\n            //Sprite.drawViewportSprite(Sprite.spindoctor[1], this.pos);\n        }\n\n        hudActions() {\n            if (this.buildFrames < this.buildFramesTotal) {\n                return [BuildTowerAction];\n            } else {\n                return [];\n            }\n        }\n    }\n\n    const SPAWN_COST_EARTH = [0, 2];\n    for (let i = 2; i <= 19; i++) {\n        SPAWN_COST_EARTH[i] = Math.floor(SPAWN_COST_EARTH[i - 1] * 1.5 + 1);\n    }\n    for (let i = 0; i < 20; i++) {\n        SPAWN_COST_EARTH[i] = SPAWN_COST_EARTH[i] * 5;\n    }\n\n    const SpawnMothAction = {\n        defaultTapAction() {\n            return false;\n        },\n\n        buttonSprite() {\n            return Sprite.buttons[0];\n        },\n\n        buttonSelectedSprite() {\n            return Sprite.buttons[1];\n        },\n\n        drawSelectedText(u, v) {\n            let cost = SPAWN_COST_EARTH[game.activeMoths()];\n            let text = game.canAfford(cost) ? 'LURE MOTH \\ne' + cost : 'LURE MOTH \\ner' + cost;\n\n            Text.drawParagraph(\n                Viewport.ctx,\n                text,\n                u,\n                v\n            );\n        },\n\n        tap() {\n            let cost = SPAWN_COST_EARTH[game.activeMoths()];\n\n            if (game.canAfford(cost)) {\n                game.payCost(cost);\n                game.entities.push(new Moth(centerxy(qr2xy(World.selected))));\n                return true;\n            }\n        }\n    };\n\n    /**\n     * Monster\n     */\n    class CoffinBuilding {\n        constructor(qr) {\n            this.qr = { ...qr };\n\n            this.title = 'YOUR COFFIN \\nLAST CHANCE';\n            this.portraitSprite = Sprite.buildings[1];\n            this.lightlevel = 9;\n        }\n\n        think() {\n        }\n\n        draw() {\n            let xy = qr2xy(this.qr);\n\n            //Viewport.ctx.drawImage(Sprite.tiles[tiles[y][x] - 1].img, x * 8 + offset.u, y * 8 + offset.v);\n            Sprite.drawViewportSprite(Sprite.buildings[1], xy);\n\n            //Sprite.drawViewportSprite(Sprite.spindoctor[0], this.pos, game.frame / 5);\n            //Sprite.drawViewportSprite(Sprite.spindoctor[1], this.pos);\n        }\n\n        hudActions() {\n            return [SpawnMothAction];\n        }\n    }\n\n    // ghost?\n\n    /**\n     * Monster\n     */\n    class Ghost {\n        constructor(pos) {\n            this.pos = { ...pos };\n            this.hp = 100;\n            this.damage = [];\n            this.vel = { x: 0, y: 0 };\n            this.radius = 2;\n            this.mass = 0.2;\n            this.lastAttack = 0;\n            this.state = CHASE;\n            this.enemy = true;\n        }\n\n        think() {\n            let targets = game.entities.filter(x => x instanceof Moth);\n            let bestTarget = targets[0];\n\n            console.log(targets.map(target => target.pos));\n\n            if (!bestTarget) return;\n\n            let bestDiff = vectorBetween(this.pos, bestTarget.pos);\n            for (let i = 1; i < targets.length; i++) {\n                let diff = vectorBetween(this.pos, targets[i].pos);\n                if (diff.m < bestDiff.m) {\n                    bestTarget = targets[i];\n                    bestDiff = diff;\n                }\n            }\n\n            const pathToTarget = World.pathToTarget(this.pos, bestTarget.pos);\n\n            let diff = vectorBetween(this.pos, pathToTarget);\n\n            if (this.state === CHASE) {\n                if (bestDiff.m < 8) {\n                    console.log('KILL');\n                    bestTarget.damage.push({ amount: 10, vector: diff, knockback: 0 });\n                    this.cull = true;\n                } else {\n                    diff.m = clamp(diff.m, 0, 0.4);\n                    this.vel = {\n                        x: (this.vel.x + diff.x * diff.m) / 2,\n                        y: (this.vel.y + diff.y * diff.m) / 2\n                    };\n                }\n            } else if (this.state === DEAD) {\n                Audio.play(Audio.ghostDeath);\n                this.cull = true;\n                Gore.kill(this);\n            }\n        }\n\n        draw() {\n            //if (!this.lastQR) return;\n\n            let sprite = Sprite.ghost[0];\n\n            /*for (let r = 0; r < this.targetField.length; r++) {\n                for (let q = 0; q < this.targetField[0].length; q++) {\n                    let uv = xy2uv(qr2xy({ q, r }));\n                    Text.drawText(\n                        Viewport.ctx,\n                        '' + this.targetField[r][q] || '',\n                        uv.u,\n                        uv.v\n                    );\n                }\n            }*/\n\n            /*\n            let uv = xy2uv(qr2xy(this.lastQR));\n            Viewport.ctx.fillStyle = rgba(255, 0, 0, 0.2);\n            Viewport.ctx.fillRect(uv.u + 1, uv.v + 1, 7, 7);\n\n            uv = xy2uv(qr2xy(this.nextQR));\n            Viewport.ctx.fillStyle = rgba(0, 255, 0, 0.2);\n            Viewport.ctx.fillRect(uv.u + 1, uv.v + 1, 7, 7);\n            */\n\n            /*let sprite = Sprite.stabguts[((game.frame / 12) | 0) % 2];\n            this.state === RELOAD && (sprite = Sprite.stabguts[2]);\n            this.state === ATTACK && (sprite = Sprite.stabguts[3]);*/\n            Sprite.drawViewportSprite(\n                sprite,\n                this.pos //,\n                //this.facingAngle + R90\n            );\n        }\n    }\n\n    // GatherEarthAction\n\n    const GatherEarthAction = {\n        defaultTapAction() {\n            return true;\n        },\n\n        buttonSprite() {\n            return Sprite.buttons[2];\n        },\n\n        buttonSelectedSprite() {\n            return Sprite.buttons[3];\n        },\n\n        drawSelectedText(u, v) {\n            let text = 'GATHER EARTH';\n\n            Text.drawParagraph(\n                Viewport.ctx,\n                text,\n                u,\n                v\n            );\n        },\n\n        tap() {\n            Moth.assign(moth => moth.gather(World.selected));\n            return true;\n        }\n    };\n\n    /**\n     * Monster\n     */\n    class EarthBuilding {\n        constructor(qr) {\n            this.qr = { ...qr };\n            this.resourcesLeft = 100_00;\n\n            this.title = 'EARTH';\n            this.portraitSprite = Sprite.buildings[2];\n        }\n\n        think() {\n            this.title = 'EARTH \\n' + Math.ceil(this.resourcesLeft / 100) + ' REMAINING';\n\n            if (this.resourcesLeft < 1) {\n                this.cull = true;\n            }\n        }\n\n        draw() {\n            let xy = qr2xy(this.qr);\n\n            //Viewport.ctx.drawImage(Sprite.tiles[tiles[y][x] - 1].img, x * 8 + offset.u, y * 8 + offset.v);\n            Sprite.drawViewportSprite(Sprite.buildings[2], xy);\n\n            //Sprite.drawViewportSprite(Sprite.spindoctor[0], this.pos, game.frame / 5);\n            //Sprite.drawViewportSprite(Sprite.spindoctor[1], this.pos);\n        }\n\n        hudActions() {\n            return [GatherEarthAction];\n        }\n    }\n\n    // GatherEarthAction\n\n    const MoveAction = {\n        defaultTapAction() {\n            return true;\n        },\n\n        buttonSprite() {\n            return Sprite.buttons[4];\n        },\n\n        buttonSelectedSprite() {\n            return Sprite.buttons[5];\n        },\n\n        drawSelectedText(u, v) {\n            let text = 'EXPLORE';\n\n            Text.drawParagraph(\n                Viewport.ctx,\n                text,\n                u,\n                v\n            );\n        },\n\n        tap() {\n            Moth.assign(moth => moth.moveTo(World.selected));\n            return true;\n        }\n    };\n\n    /**\n     * Movement\n     */\n    const Movement = {\n        perform(entities) {\n            // Movement only applies to active entities with positions and velocities\n            let movers = entities.filter(\n                entity => entity.pos && entity.vel && !entity.cull\n            );\n\n            // Very basic \"rounds\" of collision resolution, since we have no real physics.\n            // (As usual, \"detecting\" a collision is not the hard part... we need to resolve\n            // them too!)\n            for (let rounds = 0; rounds < 5; rounds++) {\n                // Each pair of entities only needs to interact once.\n                for (let i = 0; i < movers.length - 1; i++) {\n                    for (let j = i + 1; j < movers.length; j++) {\n                        Movement.clipVelocityEntityVsEntity(movers[i], movers[j]);\n                    }\n                }\n\n                for (let entity of movers) {\n                    Movement.clipVelocityAgainstWalls(entity);\n                }\n            }\n\n            // Now we perform all movement, even if it's not going to be perfect.\n            for (let entity of movers) {\n                entity.pos.x += entity.vel.x;\n                entity.pos.y += entity.vel.y;\n            }\n        },\n\n        clipVelocityEntityVsEntity(entity, other) {\n            if (entity.noClipEntity || other.noClipEntity) return;\n\n            let hit = intersectCircleCircle(\n                entity.pos,\n                entity.radius,\n                entity.vel,\n                other.pos,\n                other.radius,\n                other.vel\n            );\n            if (hit) {\n                if (entity.bounce && other.bounce) {\n                    entity.vel.x = -hit.nx * hit.m;\n                    entity.vel.y = -hit.ny * hit.m;\n                    other.vel.x = hit.nx * hit.m;\n                    other.vel.y = hit.ny * hit.m;\n                } else {\n                    // Not a bug: we \"add\" the mass of the opposing entity to our own velocity when deciding who\n                    // is at fault for the collision. Entity velocities adjust in relation to their fault level.\n                    let entityM = normalizeVector(entity.vel).m + other.mass,\n                        otherM = normalizeVector(other.vel).m + entity.mass,\n                        entityI = entity.bounce ? 0.1 : 1,\n                        otherI = other.bounce ? 0.1 : 1;\n                    entity.vel.x -=\n                        (hit.nx * hit.m * entityI * entityM) / (entityM + otherM);\n                    entity.vel.y -=\n                        (hit.ny * hit.m * entityI * entityM) / (entityM + otherM);\n                    other.vel.x +=\n                        (hit.nx * hit.m * otherI * otherM) / (entityM + otherM);\n                    other.vel.y +=\n                        (hit.ny * hit.m * otherI * otherM) / (entityM + otherM);\n                }\n            }\n        },\n\n        clipVelocityAgainstWalls(entity) {\n            if (entity.noClipWall) return;\n\n            if (entity.pos.y < -1000) {\n                console.log('FUUUUUUUUUUUUUUUU');\n            }\n\n\n            for (let tile of tilesHitByCircle(\n                entity.pos,\n                entity.vel,\n                entity.radius\n            )) {\n                if (!tileIsPassable(tile.q, tile.r)) {\n                    let bounds = [\n                        qr2xy(tile),\n                        qr2xy({ q: tile.q + 1, r: tile.r + 1 })\n                    ];\n                    let hit = intersectCircleRectangle(\n                        entity.pos,\n                        {\n                            x: entity.pos.x + entity.vel.x,\n                            y: entity.pos.y + entity.vel.y\n                        },\n                        entity.radius,\n                        bounds\n                    );\n\n                    // The \"math\" part of detecting collision with walls is buried in the geometry functions\n                    // above, but it's not the whole story -- if we do detect a collision, we still need to\n                    // decide what to do about it.\n                    //\n                    // If the normal vector is horizontal or vertical, we zero out the portion of the vector\n                    // moving into the wall, allowing frictionless sliding (if we wanted to perform friction,\n                    // we could also reduce the other axis slightly).\n                    //\n                    // If the normal vector is not 90*, we \"back up\" off the wall by exactly the normal vector.\n                    // If the player runs into a corner at EXACTLY a 45 degree angle, they will simply \"stick\"\n                    // on it -- but one degree left or right and they'll slide around the corner onto the wall,\n                    // which is the desired result.\n                    if (hit) {\n                        if (entity.bounce) {\n                            if (hit.nx === 0) {\n                                entity.vel.y = -entity.vel.y;\n                            } else if (hit.ny === 0) {\n                                entity.vel.x = -entity.vel.x;\n                            } else {\n                                entity.vel.x += hit.nx;\n                                entity.vel.y += hit.ny;\n                            }\n                        } else {\n                            if (hit.nx === 0) {\n                                entity.vel.y = hit.y - entity.pos.y;\n                            } else if (hit.ny === 0) {\n                                entity.vel.x = hit.x - entity.pos.x;\n                            } else {\n                                entity.vel.x += hit.nx;\n                                entity.vel.y += hit.ny;\n                            }\n                        }\n                    }\n                }\n            }\n        }\n    };\n\n    // Damage\n\n    /**\n     * Damage\n     */\n    const Damage = {\n        perform(entities) {\n            let hit = false;\n            for (let entity of entities) {\n                if (entity.hp) {\n                    if (entity.damage.length > 0) {\n                        if (entity.state !== DEAD && entity.state !== SPAWN) {\n                            for (let damage of entity.damage) {\n                                if (entity === game.player) {\n                                    game.entities.push(\n                                        new HealthChunkAnimation(\n                                            entity.hp,\n                                            damage.amount\n                                        )\n                                    );\n                                }\n                                entity.hp -= damage.amount;\n                                damage.vector.m = damage.knockback;\n                                entity.vel = vectorAdd(entity.vel, damage.vector);\n                                entity.lastDamage = damage;\n                                Gore.damage(entity);\n                                hit = true;\n                            }\n                        }\n                        entity.damage = [];\n                    }\n                    if (entity.hp <= 0 && entity.state !== DEAD) {\n                        entity.state = DEAD;\n                    }\n                }\n            }\n\n            if (hit) Audio.play(Audio.damage);\n        }\n    };\n\n    // Wave\n\n    const WAVES = [\n        // Wave 1\n        [\n            [0, 1],\n            [5, 1],\n            [10, 1],\n            [15, 1],\n            [20, 1],\n            [21, 1],\n            [22, 1]\n        ]\n    ];\n\n    class Wave {\n        constructor(waveNumber) {\n            waveNumber = waveNumber % WAVES.length;\n\n            this.upcoming = [...WAVES[waveNumber]];\n            this.countdown = 4 * 60;\n            this.incoming = false;\n            this.frame = 0;\n            this.lastFrame = this.upcoming[this.upcoming.length - 1][0] * 60;\n        }\n\n        update() {\n            this.countdown--;\n\n            if (this.countdown >= 0 && this.countdown <= 2 * 60 && this.countdown % 60 === 0) {\n                Audio.play(Audio.waveCountdown);\n            }\n\n            if (this.countdown <= 0) {\n                this.incoming = true;\n\n                for (let i = 0; i < this.upcoming.length; i++) {\n                    if (this.frame === this.upcoming[i][0] * 60) {\n                        game.monstersPending.push(Ghost);\n                    }\n                }\n\n                this.frame++;\n            }\n\n            if (this.frame >= this.lastFrame) {\n                game.wave = undefined;\n            }\n        }\n    }\n\n    class VictoryScreen {\n        constructor() {\n            this.frames = 0;\n        }\n\n        update() {\n            this.frames++;\n\n            return;\n        }\n\n        draw() {\n            //Viewport.ctx.fillStyle = rgba(13, 43, 69, clamp(this.frames / 200, 0, 1));\n            Viewport.ctx.fillStyle = rgba(36, 26, 20, clamp(this.frames / 200, 0, 1));\n            Viewport.ctx.fillRect(0, 0, Viewport.width, Viewport.height);\n\n            let width = Viewport.width - 32;\n            let x = 16;\n            let y = 16;\n\n            let message = 'ESCAPE! \\n' +\n                '                    \\n' +\n                'VILLAGERS STIR UNEASILY IN THEIR BEDS AS YOU EMERGE INTO MOONLIGHT. YOU SENSE WARM BODIES ALL AROUND YOU, RIPE FOR PICKING. IT IS ONLY A MATTER OF TIME NOW BEFORE YOU REGAIN YOUR FULL NECROMANTIC POWER. \\n' +\n                '                    \\n' +\n                'CONGRATULATIONS... AND THE END.';\n\n            message = message.slice(0, this.frames);\n\n            Text.drawParagraph(\n                Viewport.ctx,\n                message,\n                x,\n                y,\n                width,\n                1,\n                1\n            );\n        }\n    }\n\n    /**\n     * Monster\n     */\n    class ExitBuilding {\n        constructor(qr) {\n            this.qr = { ...qr };\n\n            this.title = 'REACH EXIT \\nTO ESCAPE';\n            this.portraitSprite = Sprite.buildings[3];\n            this.lightlevel = 4;\n        }\n\n        think() {\n            let moths = Moth.sortMoths();\n            let pos = centerxy(qr2xy(this.qr));\n\n            for (let moth of moths) {\n                let dist = vectorBetween(moth.pos, pos);\n                if (dist.m < ACTION_DISTANCE) {\n                    game.screen = new VictoryScreen();\n                    return;\n                }\n            }\n        }\n\n        draw() {\n            let xy = qr2xy(this.qr);\n\n            //Viewport.ctx.drawImage(Sprite.tiles[tiles[y][x] - 1].img, x * 8 + offset.u, y * 8 + offset.v);\n            Sprite.drawViewportSprite(Sprite.buildings[3], xy);\n\n            //Sprite.drawViewportSprite(Sprite.spindoctor[0], this.pos, game.frame / 5);\n            //Sprite.drawViewportSprite(Sprite.spindoctor[1], this.pos);\n        }\n\n        hudActions() {\n            return [MoveAction];\n        }\n    }\n\n    // World\n\n    const World = {\n        init() {\n            this.reset();\n        },\n\n        draw() {\n            let tiles = this.floors[0].tiles;\n            //console.log(Camera.pos);\n            //Camera.pos.x++;\n            let offset = xy2uv({ x: 0, y: 0 });\n\n            //console.log(offset);\n\n            for (let r = 0; r < tiles.length; r++) {\n                for (let q = 0; q < tiles[0].length; q++) {\n                    //Viewport.ctx.globalAlpha = clamp(this.lightmap[y][x] / 5, 0.1, 1);\n                    if (tiles[r][q] > 0) {\n                        //console.log(x, y, tiles[y][x], Sprite.tiles[tiles[y][x] - 1]);\n                       Viewport.ctx.drawImage(Sprite.tiles[tiles[r][q] - 1].img, q * TILE_SIZE + offset.u, r * TILE_SIZE + offset.v);\n\n\n                       //Text.drawText(Viewport.ctx, '' + this.lightmap[y][x], x * TILE_SIZE + offset.u, y * TILE_SIZE + offset.v);\n                    }\n                }\n            }\n\n            //Viewport.ctx.globalAlpha = 1;\n\n            /*\n            if (Game.frame % 133 === 0) {\n                //console.log('generating visions');\n                this.visions = [];\n                for (let i = 0; i < 10; i++) {\n                    this.visions.push([\n                        Math.floor(Math.random() * tiles[0].length),\n                        Math.floor(Math.random() * tiles.length),\n                        String.fromCharCode(97 + Math.floor(Math.random() * 26))\n                    ]);\n                }\n            } else if (Game.frame % 133 >= 5 && Game.frame % 133 <= 25) {\n                for (let vision of this.visions) {\n                    Screen.writeOnMap(vision[0], vision[1], vision[2], Screen.RED);\n                }\n            }\n            */\n\n            for (let building of this.buildings) {\n                building.draw();\n            }\n        },\n\n        drawLightmap() {\n            let tiles = this.tiles;\n            let offset = xy2uv({ x: 0, y: 0 });\n\n            for (let r = 0; r < tiles.length; r++) {\n                for (let q = 0; q < tiles[0].length; q++) {\n                    if (tiles[r][q] > 0) {\n                        let lightlevel = 1 - clamp(this.lightmap[r][q] / 5, 0.1, 1);\n                        if (this.fogofwar[r][q] === 0) lightlevel = 1;\n\n                        Viewport.ctx.globalAlpha = lightlevel;\n                        Viewport.ctx.drawImage(Sprite.tile_background[0].img, q * TILE_SIZE + offset.u, r * TILE_SIZE + offset.v);\n\n                        //Viewport.ctx.fillStyle = rgba(36, 26, 20, lightlevel);\n                        //Viewport.ctx.fillRect(q * TILE_SIZE + offset.u, r * TILE_SIZE + offset.v, TILE_SIZE, TILE_SIZE);\n                    }\n                }\n            }\n\n            Viewport.ctx.globalAlpha = 1;\n        },\n\n        reset() {\n            // We want to be careful and CLONE (not reference) the world data, because\n            // this will be our \"working copy\" -- rooms and objects and even tiles might\n            // get updated and moved during game logic.\n            this.floors = WorldData.floors.map(floor => {\n                return {\n                    tiles: floor.tiles.map(row => [...row]),\n                    objects: floor.objects.map(object => ({ ...object })),\n                    //objects: floor.objects.map(object => ({ id: object[0], x: object[1], y: object[2], type: object[3] })),\n                    // *COMBAT*\n                    //triggers: floor.triggers.map(trigger => ({ ...trigger }))\n                };\n            });\n            this.bounds = WorldData.bounds;\n            this.spawn = { q: WorldData.spawn[0], r: WorldData.spawn[1] };\n\n            this.buildings = [];\n            this.buildings.push(new CoffinBuilding(this.spawn));\n\n            for (let b of this.floors[0].objects) {\n                if (b.name === 'EARTH') {\n                    this.buildings.push(new EarthBuilding({ q: b.x, r: b.y }));\n                } else if (b.name === 'EXIT') {\n                    this.buildings.push(new ExitBuilding({ q: b.x, r: b.y }));\n                    this.exit = { q: b.x, r: b.y };\n                }\n            }\n\n            this.selected = undefined;\n\n            this.tiles = this.floors[0].tiles;\n            this.width = this.tiles[0].length;\n            this.height = this.tiles.length;\n\n            this.lightmap = array2d(this.width, this.height, () => 0);\n            this.fogofwar = array2d(this.width, this.height, () => 0);\n\n            this.cachedFields = {};\n\n            this.makePrettyWalls();\n        },\n\n        update() {\n            for (let building of this.buildings) {\n                building.think();\n            }\n\n            this.updateLightmap();\n        },\n\n        canMoveInto(pos) {\n            let tile = this.tileAt(pos);\n            if (tile === 46 /* . */) return true;\n            return false;\n        },\n\n        isSeeThrough(pos) {\n            return this.SEE_THROUGH.includes(this.floors[pos.z].tiles[pos.y][pos.x]);\n        },\n\n        refreshVisible(pos) {\n            this.floors[pos.z];\n            //FieldOfView.resetVisible(floor.visible);\n            //FieldOfView.refreshVisible(pos, floor.visible, floor.seen);\n        },\n\n        tap(uv) {\n            let qr = xy2qr(uv2xy(uv));\n            let tile = this.tileAt(qr);\n\n            if (!tile || tile > 8 || !this.fogofwar[qr.r][qr.q]) {\n                this.selected = undefined;\n            } else {\n                if (this.selected && this.selected.q === qr.q && this.selected.r === qr.r) {\n                    let building = this.buildingAt(this.selected);\n                    if (building) {\n                        let actions = building.hudActions();\n                        if (actions[0] && actions[0].defaultTapAction()) {\n                            actions[0].tap();\n                        }\n                    } else {\n                        MoveAction.tap();\n                    }\n                } else {\n                    // single tap, reselect\n                    this.selected = qr;\n                    this.buildingAt(this.selected);\n                    /*if (building) {\n                        let actions = building.hudActions();\n                        if (actions[0] && actions[0].defaultTapAction) {\n                            Hud.selectedAction = actions[0];\n                        }\n                    }*/\n                }\n            }\n        },\n\n        tileAt(qr) {\n            if (qr) {\n                return this.floors[0].tiles[qr.r]?.[qr.q];\n            }\n        },\n\n        buildingAt(qr) {\n            if (qr) {\n                for (let building of this.buildings) {\n                    if (building.qr.q === qr.q && building.qr.r === qr.r) return building;\n                }\n            }\n        },\n\n        updateLightmap() {\n            /*\n            for (let r = 0; r < this.height; r++) {\n                for (let q = 0; q < this.width; q++) {\n                    this.lightmap[r][q] = 0;\n                }\n            }\n\n            for (let b of this.buildings) {\n                for (let r = -3; r <= 3; r++) {\n                    for (let q = -3; q <= 3; q++) {\n                        let diff = 5 - Math.abs(r) - Math.abs(q);\n                        if (diff <= 0) continue;\n\n                        let tq = b.qr.q + q, tr = b.qr.r + r;\n                        if (tq >= 0 && tr >= 0 && tq < this.width && tr < this.height) {\n                            if (this.lightmap[tr][tq] < diff) {\n                                this.lightmap[tr][tq] = diff;\n                            }\n                        }\n                    }\n                }\n            }\n\n            for (let e of game.entities) {\n                if (!(e instanceof Moth)) continue;\n                let qr = xy2qr(e.pos);\n                for (let r = -4; r <= 4; r++) {\n                    for (let q = -4; q <= 4; q++) {\n                        let diff = 9 - Math.abs(r) - Math.abs(q);\n                        if (diff <= 0) continue;\n\n                        let tq = qr.q + q, tr = qr.r + r;\n                        if (tq >= 0 && tr >= 0 && tq < this.width && tr < this.height) {\n                            if (this.lightmap[tr][tq] < diff) {\n                                this.lightmap[tr][tq] = diff;\n                            }\n                        }\n                    }\n                }\n            }*/\n\n            let lights = [];\n\n            for (let building of this.buildings) {\n                if (building.lightlevel) {\n                    lights.push({ ...building.qr, light: building.lightlevel });\n                }\n            }\n\n            for (let entity of game.entities) {\n                if (entity.lightlevel) {\n                    lights.push({ ...xy2qr(entity.pos), light: entity.lightlevel });\n                }\n            }\n\n            this.lightmap = floodlight(this.tiles, lights);\n            for (let r = 0; r < this.lightmap.length; r++) {\n                for (let q = 0; q < this.lightmap[0].length; q++) {\n                    if (this.lightmap[r][q] > this.fogofwar[r][q]) {\n                        this.fogofwar[r][q] = 1;\n                    }\n                }\n            }\n        },\n\n        pathToTarget(from, to) {\n            let qrFrom = xy2qr(from);\n            let qrTo = xy2qr(to);\n\n            let dist = manhattan(qrFrom, qrTo);\n            if (dist <= 1) {\n                return to;\n            }\n\n            let key = [qrTo.q, qrTo.r].join(',');\n\n            // Our game doesn't support any kinds of doors or world destruction or\n            // anything like that, so once we've calculated a field we don't need to\n            // recalculate it.\n            let field = this.cachedFields[key];\n            if (!field) {\n                field = this.cachedFields[key] = flood(this.tiles, qrTo);\n            }\n            console.log(Object.keys(this.cachedFields).length);\n\n            let options = [\n                [qrFrom.q + 1, qrFrom.r],\n                [qrFrom.q - 1, qrFrom.r],\n                [qrFrom.q, qrFrom.r + 1],\n                [qrFrom.q, qrFrom.r - 1]\n            ];\n\n            for (let option of options) {\n                option.push(field[option[1]][option[0]]);\n            }\n            options.sort((a, b) => a[2] - b[2]);\n\n            return centerxy(qr2xy({ q: options[0][0], r: options[0][1] }));\n        },\n\n        makePrettyWalls() {\n            for (let r = 0; r < this.tiles.length; r++) {\n                for (let q = 0; q < this.tiles[0].length; q++) {\n                    if (this.tiles[r][q] === TILE_CORNER_INNER) {\n                        let bitmask = 0;\n\n                        if ((this.tiles[r - 1]?.[q - 1] || 99) < 8) bitmask |= 0b100_000_000;\n                        if ((this.tiles[r - 1]?.[q] || 99) < 8)     bitmask |= 0b010_000_000;\n                        if ((this.tiles[r - 1]?.[q + 1] || 99) < 8) bitmask |= 0b001_000_000;\n                        if ((this.tiles[r]?.[q - 1] || 99) < 8)     bitmask |= 0b000_100_000;\n                        if ((this.tiles[r]?.[q + 1] || 99) < 8)     bitmask |= 0b000_001_000;\n                        if ((this.tiles[r + 1]?.[q - 1] || 99) < 8) bitmask |= 0b000_000_100;\n                        if ((this.tiles[r + 1]?.[q] || 99) < 8)     bitmask |= 0b000_000_010;\n                        if ((this.tiles[r + 1]?.[q + 1] || 99) < 8) bitmask |= 0b000_000_001;\n\n                        Sprite.getDynamicTile(bitmask);\n                        this.tiles[r][q] = TILE_DYNAMIC + bitmask;\n                    }\n                }\n            }\n        }\n    };\n\n    // Hud\n\n    const TRAY_HEIGHT = 18;\n\n    /**\n     * Hud\n     *\n     * Health bars, ammo, etc.\n     */\n    const Hud = {\n        init() {\n            this.wipCanvas = createCanvas(7, 7);\n        },\n\n        update() {\n            if (World.selected) {\n                let tile = World.tileAt(World.selected);\n                let building = World.buildingAt(World.selected);\n                if (building) {\n                    this.actions = building.hudActions();\n                } else if (tile >= 1 && tile <= 4) {\n                    this.actions = [MoveAction, BuildTowerAction];\n                } else {\n                    this.actions = [];\n                }\n            } else {\n                this.actions = [];\n            }\n\n            if (Input.dragging) {\n                this.selectedAction = undefined;\n            }\n        },\n\n        draw() {\n            Viewport.ctx.fillStyle = rgba(36, 26, 20, 0.4);\n            Viewport.ctx.fillRect(0, 0, Viewport.width, 9);\n            Viewport.ctx.fillRect(0, 9, Viewport.width, 1);\n            // Glyphs\n\n            if (game.wave) {\n                if (game.wave.incoming) {\n                    let text = 'INCOMING';\n                    let width = Text.measureWidth(text, 1);\n                    let u = (Viewport.width - width) / 2;\n                    let color = Math.floor(game.frame / 60) % 2 === 0 ? Text.duotone : Text.duotone_red;\n                    Text.drawText(Viewport.ctx, text, u, 2, 1, color);\n                } else {\n                    let seconds = Math.ceil(game.wave.countdown / 60);\n\n                    if (seconds <= 30) {\n                        let text = 'NEXT WAVE';\n                        let width = Text.measureWidth(text, 1) + 2;\n                        let u = (Viewport.width - width) / 2;\n                        Text.drawText(Viewport.ctx, 'NEXT WAVE ', u, 2);\n\n                        this.wipCanvas.ctx.clearRect(0, 0, 7, 7);\n                        this.wipCanvas.ctx.fillStyle = rgba(255, 212, 163, 1);\n                        this.wipCanvas.ctx.beginPath();\n                        this.wipCanvas.ctx.moveTo(3.5, 3.5);\n                        this.wipCanvas.ctx.lineTo(3.5, 0);\n                        this.wipCanvas.ctx.arc(3.5, 3.5, 3, Math.PI * 1.5, Math.PI * 1.5 + (seconds / 30 * Math.PI * 2));\n                        this.wipCanvas.ctx.fill();\n\n                        Viewport.ctx.drawImage(this.wipCanvas.canvas, u + width, 1);\n                    }\n                }\n            }\n\n            let moths = game.entities.filter(x => x instanceof Moth);\n            for (let i = 0; i < moths.length; i++) {\n                Viewport.ctx.drawImage(Sprite.moth[1].img, 2 + i * 4, 2);\n            }\n\n            let cornerText = '' + game.earth + 'e';\n            let cornerWidth = Text.measureWidth(cornerText, 1);\n\n            Viewport.ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';\n            Text.drawText(Viewport.ctx, cornerText, Viewport.width - cornerWidth - 2, 2);\n\n            if (Input.pointer) {\n                let u = Input.pointer.u;\n                let v = Input.pointer.v;\n                let xy = uv2xy(Input.pointer);\n                let qr = xy2qr(xy);\n\n                Text.drawText(Viewport.ctx, '' + u + ',' + v + '. ' + xy.x + ',' + xy.y + '. ' + qr.q + ',' + qr.r + '.', Viewport.width - 100, 20);\n                if (World.selected) {\n                    let tile = World.tiles[World.selected.r][World.selected.q];\n                    if (tile > 20) tile = tile - 20;\n                    Text.drawText(Viewport.ctx, '' + World.selected.q + ',' + World.selected.r + '. ' + tile.toString(2).padStart(9, '0'), Viewport.width - 100, 29);\n                }\n            }\n\n            // Health\n            /*\n            let hp = clamp(game.player.hp, 0, 100);\n            Viewport.ctx.drawImage(Sprite.hud_healthbar[0].img, 2, 2);\n            Viewport.ctx.drawImage(\n                Sprite.hud_healthbar[1].img,\n                0,\n                0,\n                hp + 8,\n                8,\n                2,\n                2,\n                hp + 8,\n                8\n            );\n            */\n\n            // Shells\n            /*let sprite = Sprite.hud_shells_full;\n            for (let i = 0; i < game.player.shellsMax; i++) {\n                if (i + 1 > game.player.shellsLeft)\n                    sprite = Sprite.hud_shells_empty;\n                Viewport.ctx.drawImage(sprite.img, 15 + 6 * i, 10);\n            }*/\n\n            // Glyphs\n            // Text.drawText(Viewport.ctx, 'stuvw', Viewport.width - HUD_PAGE_TEXT_U - 60, 4, 2, Text.blue, Text.blue_shadow);\n\n            if (World.selected) {\n                /*Viewport.ctx.globalAlpha = 0.5;\n                let uv = xy2uv(qr2xy(World.selected));\n                Viewport.ctx.drawImage(Sprite.hud_tile_selected[Math.floor(game.frame / 30) % 2].img, uv.u, uv.v);\n                Viewport.ctx.globalAlpha = 1;*/\n\n                let uv = xy2uv({ x: World.selected.q * 8, y: World.selected.r * 8 });\n                Viewport.ctx.fillStyle = rgba(255, 212, 163, 0.25);\n                Viewport.ctx.fillRect(uv.u, uv.v, 9, 9);\n            }\n\n            // Debugging - viewport width/height\n            /*\n            Text.drawRightText(\n                Viewport.ctx,\n                [Viewport.scale, Viewport.width, Viewport.height, 'stuvwx'].join(', '),\n                Viewport.width - 4,\n                Viewport.height - 18\n            );\n            */\n\n            Viewport.ctx.fillStyle = '#ffd4a3';\n            Viewport.ctx.fillRect(0, Viewport.height - TRAY_HEIGHT, Viewport.width, 1);\n\n            Viewport.ctx.fillStyle = '#8d697a';\n            Viewport.ctx.fillRect(0, Viewport.height - TRAY_HEIGHT + 1, Viewport.width, 1);\n\n            Viewport.ctx.fillStyle = '#203c56';\n            Viewport.ctx.fillRect(0, Viewport.height - TRAY_HEIGHT + 2, Viewport.width, TRAY_HEIGHT - 2);\n\n            Viewport.ctx.fillStyle = '#8d697a';\n            Viewport.ctx.fillRect(0, Viewport.height - 2, Viewport.width, 2);\n\n            //Viewport.ctx.drawImage(Sprite.hud_tray_building[0].img, 0, Viewport.height - TRAY_HEIGHT + 1);\n\n            Viewport.ctx.drawImage(Sprite.hud_tray_divider[0].img, -2, Viewport.height - TRAY_HEIGHT + 1);\n            Viewport.ctx.drawImage(Sprite.hud_tray_divider[0].img, 64, Viewport.height - TRAY_HEIGHT + 1);\n            Viewport.ctx.drawImage(Sprite.hud_tray_divider[0].img, Viewport.width - 3, Viewport.height - TRAY_HEIGHT + 1);\n\n            if (World.selected) {\n                let building = World.buildingAt(World.selected);\n                if (building) {\n                    Viewport.ctx.drawImage(building.portraitSprite.img, 3, Viewport.height - TRAY_HEIGHT - 1);\n\n                    Text.drawParagraph(\n                        Viewport.ctx,\n                        building.title,\n                        14,\n                        Viewport.height - TRAY_HEIGHT + 3,\n                        Viewport.width\n                    );\n                } else {\n                    let tile = World.tileAt(World.selected);\n                    console.log(World.selected, tile, TILE_DESCRIPTIONS[tile - 1]);\n                    Viewport.ctx.drawImage(Sprite.tile_background[1].img, 4, Viewport.height - TRAY_HEIGHT + 6);\n                    Viewport.ctx.drawImage(Sprite.tiles[tile - 1].img, 3, Viewport.height - TRAY_HEIGHT + 5);\n                    Text.drawParagraph(\n                        Viewport.ctx,\n                        TILE_DESCRIPTIONS[tile - 1],\n                        14,\n                        Viewport.height - TRAY_HEIGHT + 3,\n                        Viewport.width\n                    );\n                }\n            }\n\n            let selectedActionIndex;\n\n            for (let i = 0; i < this.actions.length; i++) {\n                let action = this.actions[i];\n                let uvAction = this.uvTrayAction(i);\n                Viewport.ctx.drawImage(Sprite.hud_tray_divider[0].img, uvAction.u + 11, Viewport.height - TRAY_HEIGHT + 1);\n                Viewport.ctx.drawImage(action.buttonSprite().img, uvAction.u, uvAction.v);\n\n                if (this.selectedAction === action) selectedActionIndex = i;\n            }\n\n            if (selectedActionIndex >= 0) {\n                let uvAction = this.uvTrayAction(selectedActionIndex);\n\n                Viewport.ctx.drawImage(Sprite.hud_tray_popup[0].img, uvAction.u - 23, uvAction.v - 19);\n\n                Viewport.ctx.drawImage(this.selectedAction.buttonSelectedSprite().img, uvAction.u, uvAction.v);\n\n                this.selectedAction.drawSelectedText(uvAction.u - 23 + 3, uvAction.v - 19 + 3);\n            }\n\n            if (Input.pointer) {\n                if (game.dialog) {\n                    Viewport.ctx.globalAlpha = 0.5;\n                }\n                //Sprite.drawViewportSprite(Sprite.hud_crosshair[0], uv2xy(Input.pointer), game.frame / 72);\n                Sprite.drawViewportSprite(Sprite.hud_mouse, uv2xy(Input.pointer));\n                Viewport.ctx.globalAlpha = 1;\n            }\n\n            /*\n            Visual Effect Warning\n            let gorp = game.frame % 60;\n            let x = (gorp / 60) * (Viewport.width + 100) - 50;\n\n            Viewport.ctx.fillStyle = 'rgba(255, 0, 0, 0.6)';\n            Viewport.ctx.beginPath();\n            Viewport.ctx.moveTo(x + 20, 0);\n            Viewport.ctx.lineTo(x +0, Viewport.height);\n            Viewport.ctx.lineTo(x+40, Viewport.height);\n            Viewport.ctx.lineTo(x+60, 0);\n            Viewport.ctx.closePath();\n            Viewport.ctx.fill();\n            */\n        },\n\n        uvTrayAction(i) {\n            return { u: 68 + i * 15, v: Viewport.height - 15 };\n        },\n\n        tap(uv) {\n            if (uv.v > Viewport.height - TRAY_HEIGHT) {\n                for (let i = 0; i < this.actions.length; i++) {\n                    let uvAction = this.uvTrayAction(i);\n                    if (uv.u >= uvAction.u && uv.u <= uvAction.u + 12 && uv.v >= uvAction.v && uv.v <= uvAction.v + 12) {\n                        if (this.actions[i] === this.selectedAction) {\n                            if (this.selectedAction.tap()) {\n                                this.selectedAction = undefined;\n                            }\n                        } else {\n                            this.selectedAction = this.actions[i];\n                        }\n                        return true;\n                    }\n                }\n\n                this.selectedAction = undefined;\n                return true;\n            }\n\n            this.selectedAction = undefined;\n            return false;\n        }\n    };\n\n    // Camera\n\n    const Camera = {\n        init() {\n            this.pos = { x: 0, y: 0 };\n            this.forceTarget = undefined;\n            this.vel = { x: 0, y: 0 };\n        },\n\n        update() {\n            if (this.forceTarget) {\n                let dist = vectorBetween(this.pos, this.forceTarget);\n\n                if (dist.m < 1) {\n                    this.forceTarget = undefined;\n                    return;\n                }\n\n                dist.m = clamp(dist.m, 0, 2);\n\n                let newVelocity = vector2point(dist);\n                this.vel = {\n                    x: (this.vel.x + newVelocity.x) / 2,\n                    y: (this.vel.y + newVelocity.y) / 2\n                };\n\n                this.pos.x += this.vel.x;\n                this.pos.y += this.vel.y;\n            }\n\n            if (Input.pressed[Input.Action.RAW_TOUCH]) {\n                this.dragStart = { ...this.pos };\n            }\n\n            if (Input.dragging) {\n                this.pos = {\n                    x: this.dragStart.x - Input.dragVector.x,\n                    y: this.dragStart.y - Input.dragVector.y\n                };\n            }\n\n            //this.pos = Game.player.pos;\n            //this.pos = { x: 0, y: 0, z: 0 };\n        }\n    };\n\n    function normalizeVector(p) {\n        let m = Math.sqrt(p.x * p.x + p.y * p.y);\n        return m === 0 ? { x: 0, y: 0, m: 0 } : { x: p.x / m, y: p.y / m, m };\n    }\n\n    function vectorBetween(p1, p2) {\n        return normalizeVector({ x: p2.x - p1.x, y: p2.y - p1.y });\n    }\n\n    function angle2vector(r, m) {\n        return { x: Math.cos(r), y: Math.sin(r), m: m || 1 };\n    }\n\n    function vector2angle(v) {\n        let angle = Math.atan2(v.y, v.x);\n        if (angle < 0) angle += R360;\n        return angle;\n    }\n\n    function vector2point(v) {\n        return { x: v.x * (v.m || 1), y: v.y * (v.m || 1) };\n    }\n\n    // Takes a series of vectors and denormalizes them and adds them together, usually resulting\n    // in a point in space. Wrap in normalizeVector to get a normalized vector again, if desired.\n    function vectorAdd(...vectors) {\n        let v = { x: 0, y: 0, m: 1 };\n        for (let vector of vectors) {\n            v.x += vector.x * (vector.m || 1);\n            v.y += vector.y * (vector.m || 1);\n        }\n        return v;\n    }\n\n    function xy2qr(pos) {\n        return { q: (pos.x / TILE_SIZE) | 0, r: (pos.y / TILE_SIZE) | 0 };\n    }\n\n    function qr2xy(pos) {\n        return { x: pos.q * TILE_SIZE, y: pos.r * TILE_SIZE };\n    }\n\n    function xy2uv(pos) {\n        return {\n            u: pos.x + Viewport.center.u - Camera.pos.x,\n            v: pos.y + Viewport.center.v - Camera.pos.y\n        };\n    }\n\n    function uv2xy(pos) {\n        return {\n            x: pos.u - Viewport.center.u + Camera.pos.x,\n            y: pos.v - Viewport.center.v + Camera.pos.y\n        };\n    }\n\n    function centerxy(pos) {\n        return {\n            x: pos.x + TILE_SIZE / 2,\n            y: pos.y + TILE_SIZE / 2\n        };\n    }\n\n    function clamp(value, min, max) {\n        return value < min ? min : value > max ? max : value;\n    }\n\n    function manhattan(qr1, qr2) {\n        return Math.abs(qr1.q - qr2.q) + Math.abs(qr1.r - qr2.r);\n    }\n\n    /**\n     * @param {XY[]} bounds  the upper-left and lower-right bounds\n     * @yields {QR}\n     */\n    function* tilesHitInBounds(bounds) {\n        for (let r = bounds[0].y / TILE_SIZE | 0; r * TILE_SIZE < bounds[1].y; r++) {\n            for (let q = bounds[0].x / TILE_SIZE | 0; q * TILE_SIZE <  bounds[1].x; q++) {\n                yield { q, r };\n            }\n        }\n    }\n\n    /**\n     * @param {XY} p1  the starting position\n     * @param {XY} p2  the ending position\n     * @param {number} r  the radius of the moving circle\n     * @yields {QR}\n     */\n    function* tilesHitBetweenCircle(p1, p2, r) {\n        let bounds = [\n            { x: Math.min(p1.x, p2.x) - r, y: Math.min(p1.y, p2.y) - r },\n            { x: Math.max(p1.x, p2.x) + r, y: Math.max(p1.y, p2.y) + r }\n        ];\n        yield* tilesHitInBounds(bounds);\n    }\n\n    /**\n     * @param {XY} p  the starting position\n     * @param {XY} v  the velocity (movement)\n     * @param {number} r  the radius of the moving circle\n     * @yields {QR}\n     */\n    function* tilesHitByCircle(p, v, r) {\n        yield* tilesHitBetweenCircle(p, { x: p.x + v.x, y: p.y + v.y }, r);\n    }\n\n    // See https://stackoverflow.com/a/18790389/80630\n    function intersectCircleRectangle(p1, p2, r, bounds) {\n        // If the bounding box around the start and end points (+radius on all\n        // sides) does not intersect with the rectangle, definitely not an\n        // intersection\n        if (\n            Math.max(p1.x, p2.x) + r < bounds[0].x ||\n            Math.min(p1.x, p2.x) - r > bounds[1].x ||\n            Math.max(p1.y, p2.y) + r < bounds[0].y ||\n            Math.min(p1.y, p2.y) - r > bounds[1].y\n        )\n            return;\n\n        let dx = p2.x - p1.x;\n        let dy = p2.y - p1.y;\n        let invdx = dx === 0 ? 0 : 1 / dx;\n        let invdy = dy === 0 ? 0 : 1 / dy;\n        let cornerX = Infinity;\n        let cornerY = Infinity;\n\n        // Check each side of the rectangle for a single-side intersection\n        // Left Side\n        if (p1.x - r < bounds[0].x && p2.x + r > bounds[0].x) {\n            let ltime = (bounds[0].x - r - p1.x) * invdx;\n            if (ltime >= 0 && ltime <= 1) {\n                let ly = dy * ltime + p1.y;\n                if (ly >= bounds[0].y && ly <= bounds[1].y) {\n                    return {\n                        x: dx * ltime + p1.x,\n                        y: ly,\n                        t: ltime,\n                        nx: -1,\n                        ny: 0,\n                        ix: bounds[0].x,\n                        iy: ly\n                    };\n                }\n            }\n            cornerX = bounds[0].x;\n        }\n        // Right Side\n        if (p1.x + r > bounds[1].x && p2.x - r < bounds[1].x) {\n            let rtime = (p1.x - (bounds[1].x + r)) * -invdx;\n            if (rtime >= 0 && rtime <= 1) {\n                let ry = dy * rtime + p2.y;\n                if (ry >= bounds[0].y && ry <= bounds[1].y) {\n                    return {\n                        x: dx * rtime + p1.x,\n                        y: ry,\n                        t: rtime,\n                        nx: 1,\n                        ny: 0,\n                        ix: bounds[1].x,\n                        iy: ry\n                    };\n                }\n            }\n            cornerX = bounds[1].x;\n        }\n        // Top Side\n        if (p1.y - r < bounds[0].y && p2.y + r > bounds[0].y) {\n            let ttime = (bounds[0].y - r - p1.y) * invdy;\n            if (ttime >= 0 && ttime <= 1) {\n                let tx = dx * ttime + p1.x;\n                if (tx >= bounds[0].x && tx <= bounds[1].x) {\n                    return {\n                        x: tx,\n                        y: dy * ttime + p1.y,\n                        t: ttime,\n                        nx: 0,\n                        ny: -1,\n                        ix: tx,\n                        iy: bounds[0].y\n                    };\n                }\n            }\n            cornerY = bounds[0].y;\n        }\n        // Bottom Side\n        if (p1.y + r > bounds[1].y && p2.y - r < bounds[1].y) {\n            let btime = (p1.y - (bounds[1].y + r)) * -invdy;\n            if (btime >= 0 && btime <= 1) {\n                let bx = dx * btime + p1.x;\n                if (bx >= bounds[0].x && bx <= bounds[1].x) {\n                    return {\n                        x: bx,\n                        y: dy * btime + p1.y,\n                        t: btime,\n                        nx: 0,\n                        ny: 1,\n                        ix: bx,\n                        iy: bounds[0].y\n                    };\n                }\n            }\n            cornerY = bounds[1].y;\n        }\n\n        // If we haven't touched anything, there is no collision\n        if (cornerX === Infinity && cornerY === Infinity) return;\n\n        // We didn't pass through a side but may be hitting the corner\n        if (cornerX !== Infinity && cornerY === Infinity) {\n            cornerY = dy > 0 ? bounds[1].y : bounds[0].y;\n        }\n        if (cornerY !== Infinity && cornerX === Infinity) {\n            cornerX = dx > 0 ? bounds[1].x : bounds[0].x;\n        }\n\n        /* Solve the triangle between the start, corner, and intersection point.\n         *\n         *           +-----------T-----------+\n         *           |                       |\n         *          L|                       |R\n         *           |                       |\n         *           C-----------B-----------+\n         *          / \\\n         *         /   \\r     _.-E\n         *        /     \\ _.-'\n         *       /    _.-I\n         *      / _.-'\n         *     S-'\n         *\n         * S = start of circle's path\n         * E = end of circle's path\n         * LTRB = sides of the rectangle\n         * I = {ix, iY} = point at which the circle intersects with the rectangle\n         * C = corner of intersection (and collision point)\n         * C=>I (r) = {nx, ny} = radius and intersection normal\n         * S=>C = cornerdist\n         * S=>I = intersectionDistance\n         * S=>E = lineLength\n         * <S = innerAngle\n         * <I = angle1\n         * <C = angle2\n         */\n        let inverseRadius = 1 / r;\n        let lineLength = Math.sqrt(dx * dx + dy * dy);\n        let cornerdx = cornerX - p1.x;\n        let cornerdy = cornerY - p1.y;\n        let cornerDistance = Math.sqrt(cornerdx * cornerdx + cornerdy * cornerdy);\n        let innerAngle = Math.acos(\n            (cornerdx * dx + cornerdy * dy) / (lineLength * cornerDistance)\n        );\n\n        // If the circle is too close, no intersection\n        if (cornerDistance < r) return;\n\n        // If inner angle is zero, it's going to hit the corner straight on.\n        if (innerAngle === 0) {\n            let time = (cornerDistance - r) / lineLength;\n\n            // Ignore if time is outside boundaries of (p1, p2)\n            if (time > 1 || time < 0) return;\n\n            let ix = time * dx + p1.x;\n            let iy = time * dy + p1.y;\n            let nx = cornerdx / cornerDistance;\n            let ny = cornerdy / cornerDistance;\n\n            return isNaN(ix)\n                ? undefined\n                : { x: ix, y: iy, t: time, nx, ny, ix: cornerX, iy: cornerY };\n        }\n\n        let innerAngleSin = Math.sin(innerAngle);\n        let angle1Sin = innerAngleSin * cornerDistance * inverseRadius;\n\n        // If the angle is too large, there is no collision\n        if (Math.abs(angle1Sin) > 1) return;\n\n        let angle1 = Math.PI - Math.asin(angle1Sin);\n        let angle2 = Math.PI - innerAngle - angle1;\n        let intersectionDistance = (r * Math.sin(angle2)) / innerAngleSin;\n        let time = intersectionDistance / lineLength;\n\n        // Ignore if time is outside boundaries of (p1, p2)\n        if (time > 1 || time < 0) return;\n\n        let ix = time * dx + p1.x;\n        let iy = time * dy + p2.y;\n        let nx = (ix - cornerX) * inverseRadius;\n        let ny = (iy - cornerY) * inverseRadius;\n\n        return isNaN(ix)\n            ? undefined\n            : { x: ix, y: iy, t: time, nx, ny, ix: cornerX, iy: cornerY };\n    }\n\n    // https://stackoverflow.com/questions/18683179/how-to-fix-circles-overlap-in-collision-response\n    //\n    // This is an incredibly simple implementation that ASSUMES very small velocities. It doesn't attempt\n    // to answer the question about \"when\" the intersection happened like the method above - may\n    // fix that in future.\n    function intersectCircleCircle(p1, r1, v1, p2, r2, v2) {\n        [v1, v2] = [vector2point(v1), vector2point(v2)];\n        let a1 = { x: p1.x + v1.x, y: p1.y + v1.y };\n        let a2 = { x: p2.x + v2.x, y: p2.y + v2.y };\n        let delta = vectorBetween(a1, a2);\n        if (delta.m < r1 + r2) {\n            return { nx: delta.x, ny: delta.y, m: r1 + r2 - delta.m };\n        }\n    }\n\n    function flood(maze, to, maxDistance = Infinity) {\n        let result = array2d(maze[0].length, maze.length, () => Infinity);\n        let stack = [{ ...to, cost: 0 }];\n        while (stack.length > 0) {\n            let { q, r, cost } = stack.shift();\n            if (result[r][q] <= cost) continue;\n            result[r][q] = cost++;\n            if (result[r][q] >= maxDistance) continue;\n            if (tileIsPassable(q + 1, r) && result[r][q + 1] > cost)\n                stack.push({ q: q + 1, r, cost });\n            if (tileIsPassable(q - 1, r) && result[r][q - 1] > cost)\n                stack.push({ q: q - 1, r, cost });\n            if (tileIsPassable(q, r + 1) && result[r + 1][q] > cost)\n                stack.push({ q, r: r + 1, cost });\n            if (tileIsPassable(q, r - 1) && result[r - 1][q] > cost)\n                stack.push({ q, r: r - 1, cost });\n        }\n        return result;\n    }\n\n    function floodlight(maze, froms, maxDistance = Infinity) {\n        let result = array2d(maze[0].length, maze.length, () => 0);\n        let stack = [...froms];\n\n        while (stack.length > 0) {\n            let { q, r, light } = stack.shift();\n            if (result[r][q] >= light) continue;\n            result[r][q] = light--;\n            if (result[r][q] >= maxDistance) continue;\n            if (tileOnMap(q + 1, r) && result[r][q + 1] < light)\n                stack.push({ q: q + 1, r, light });\n            if (tileOnMap(q - 1, r) && result[r][q - 1] < light)\n                stack.push({ q: q - 1, r, light });\n            if (tileOnMap(q, r + 1) && result[r + 1][q] < light)\n                stack.push({ q, r: r + 1, light });\n            if (tileOnMap(q, r - 1) && result[r - 1][q] < light)\n                stack.push({ q, r: r - 1, light });\n        }\n        return result;\n    }\n\n    function array2d(width, height, fn) {\n        return Array.from({ length: height }, () =>\n            Array.from({ length: width }, fn)\n        );\n    }\n\n    function tileOnMap(q, r) {\n        let tiles = World.floors[0].tiles;\n        if (q < 0 || r < 0 || r >= tiles.length || q >= tiles[r].length) {\n            return false;\n        }\n        return true;\n    }\n\n    function tileIsPassable(q, r) {\n        let tiles = World.floors[0].tiles;\n        if (q < 0 || r < 0 || r >= tiles.length || q >= tiles[r].length) {\n            return false;\n        }\n        if (tiles[r][q] >= 1 && tiles[r][q] <= 4) {\n            return true;\n        }\n\n        return false;\n    }\n\n    function rgba(r, g, b, a) {\n        return `rgba(${r},${g},${b},${a})`;\n    }\n\n    function createCanvas(width, height) {\n        let canvas = document.createElement('canvas');\n        canvas.width = width;\n        canvas.height = height;\n        let ctx = canvas.getContext('2d');\n        return { canvas, ctx };\n    }\n\n    /**\n     * This module is generated by `gulp buildAssets`.\n     */\n    const SpriteSheet =\n        /* <generated> */\n    { buildings: [ [ 0, 0, 8, 16 ], [ 8, 0, 8, 16 ], [ 16, 0, 8, 16 ], [ 24, 0, 8, 16 ] ],\n      bullet1: [ [ 0, 16, 3, 3 ] ],\n      buttons:\n       [ [ 0, 19, 12, 12 ],\n         [ 12, 19, 12, 12 ],\n         [ 24, 19, 12, 12 ],\n         [ 36, 19, 12, 12 ],\n         [ 48, 19, 12, 12 ],\n         [ 60, 19, 12, 12 ],\n         [ 72, 19, 12, 12 ],\n         [ 84, 19, 12, 12 ] ],\n      cursor: [ [ 0, 31, 10, 8 ] ],\n      font: [ [ 0, 39, 180, 12 ] ],\n      ghost: [ [ 0, 51, 5, 5 ] ],\n      gore: [ [ 0, 56, 5, 5 ], [ 5, 56, 5, 5 ], [ 10, 56, 5, 5 ], [ 15, 56, 5, 5 ] ],\n      hud_crosshair: [ [ 0, 61, 9, 9 ] ],\n      hud_tray_building: [ [ 0, 70, 13, 16 ] ],\n      hud_tray_divider: [ [ 0, 86, 5, 16 ] ],\n      hud_tray_popup: [ [ 0, 102, 60, 18 ] ],\n      hud_wip:\n       [ [ 0, 120, 7, 7 ],\n         [ 7, 120, 7, 7 ],\n         [ 14, 120, 7, 7 ],\n         [ 21, 120, 7, 7 ],\n         [ 28, 120, 7, 7 ],\n         [ 35, 120, 7, 7 ],\n         [ 42, 120, 7, 7 ],\n         [ 49, 120, 7, 7 ] ],\n      icon_mouse: [ [ 0, 127, 7, 9 ], [ 7, 127, 7, 9 ] ],\n      moth: [ [ 0, 136, 3, 3 ], [ 3, 136, 3, 3 ], [ 6, 136, 3, 3 ] ],\n      tile_background: [ [ 0, 139, 8, 8 ], [ 8, 139, 8, 8 ] ],\n      tiles:\n       [ [ 0, 147, 8, 8 ],\n         [ 8, 147, 8, 8 ],\n         [ 16, 147, 8, 8 ],\n         [ 24, 147, 8, 8 ],\n         [ 32, 147, 8, 8 ],\n         [ 40, 147, 8, 8 ],\n         [ 48, 147, 8, 8 ],\n         [ 56, 147, 8, 8 ],\n         [ 64, 147, 8, 8 ],\n         [ 72, 147, 8, 8 ],\n         [ 80, 147, 8, 8 ],\n         [ 88, 147, 8, 8 ],\n         [ 96, 147, 8, 8 ],\n         [ 104, 147, 8, 8 ] ],\n      walls: [ [ 0, 155, 4, 4 ], [ 4, 155, 4, 4 ] ],\n      base64:\n       'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALQAAACfCAMAAABneAP1AAAAYFBMVEUAAADuw5oAAAANK0UgPFYhIickGhQuCAFTV1JUTmhcDwBtbnN1EgCNaXqPn6iRm6ObrbemraXCHQDJAADL2/zQgVnfcSbmAADuw5ru6WTwJAD78jb/ql7/1KP/7Nb///8Vya2DAAAAAnRSTlMAlm//+0kAAAOSSURBVHja7Z2JcqQ4DIadxr0bOuvcd2z8/m+5qPlpacqhmCFcmtLnOAJx1NcaccztDMMw5qbG3CWvZ1xBIPbqjO8FJLx/6RijE7wQu24Pck5VilIac8fFJucK1iGeE8TOpbnSoesKWlYjHeLLS9RT6ZTiuc6t9f4rDVBYDVw5fVy9q7R2GomAlhOYLb8QsQbRuRRAmiu/nDOIKVxIU/Kxpc+nFgrLScd29BKpHSyHPMF5Igrp1Evz/pRbUBoKLNepkwABuXRmsKLD+f20h5AjO86L/enbctLtuMjRmNa760qjD2n0fUgjwk20R9+7SPf5sL70yIUFCThAWuQT8ttIl20wT94eLqof441TSKPRukmNRunUKJR2fx2GkQfz4+ScnaOvfrqMXB/HT4TjxXn4HN0gsDyDNCS7JawJzywyw+RiOJ4j0lPoTlNUCZW7bBuR7o/hIvB6ZmnkJpBLaXyV9cnYPrnSYv0nlc59LHq6bxNEnsiPSPO+XF3Z0+J6UUj5KTniCi7HKp+We1qKgWEx+UNSdtyMdkXPAZaVo5SGJPaV0rJ353XmezoFRlYaOuLDyYEPwcYQxrzkZibzBGyUsYTIG6VM5qrLyiLLuaVB5WWbKKdpGn3ONNRJE24NTNqt6Gy8XcKn+++kRPj0REvvJ3d6/IS0Fk404axL/F+ng+zWwKQ/MJfFyJmDYT1tt7yNCBI90rXvqBVJw5ms9Uh7xqRN2qQXx6RN2qTtMW4vTIwyaaeMunWunTJ8HWqvTtoHb9ImbdImbdJrYdL2GLcXpkA4baTJbOgcJpM2lPYT0Sxt0iZt0iZt0iZt0iY9w2ue/A2C70m7e6H+RTp9i9sfQtrtkab5s9BQ2BpIjIYGgdhNpVsGQ8Hm0gijthK3L6R0o0QalYfzYNgl4xfnlhyIPijh8PV1uL89HG7vacmkATBpiRrp+xaqNMUlpU36ljgguEWw+zRI7VBGwtfCWLH/ARUwaZM2aZM26X1R/RAHqhD8Ocq8D4Hy5wjmkfY14Ys4hO8opF+ix38yEGl20i+RnMm+6vIv80jXHUWcKh1jbCdL+26peqH8S5xZ2v+mdDcK6dhJe9CpIont3se4SaVhPdTTDHpabsf62tIlHlB7lNKcpO2+XZ9b2rM09+wY/YU3IM09jf0Wu3uMOzP9hVfF76Qj3z2wn5uDu7u7a6eNu5ubo3t+UCj9cHSquD4e9RiD/wFS6eHMqLh/ewAAAABJRU5ErkJggg==' };\n    /* </generated> */\n\n    /**\n     * Sprite\n     *\n     * Encapsulates loading sprite slices from the spritesheet, organizing them, and\n     * modifying them or constructing using primitives. To save space, we use some techniques\n     * like storing only a small slice of an image in the spritesheet, then using code\n     * to duplicate it, add some randomness, etc.\n     */\n    const Sprite = {\n        // This is an exception to the rule, loading the spritesheet is a special action that\n        // happens BEFORE everything is initialized.\n        loadSpritesheet(cb) {\n            let image = new Image();\n            image.onload = cb;\n            image.src = SpriteSheet.base64;\n            Sprite.sheet = image;\n        },\n\n        init() {\n            // Base pixel font and icons (see `Text.init` for additional variations)\n            Sprite.font = initBasicSprite(SpriteSheet.font[0]);\n            Sprite.icon_mouse_lmb = initBasicSprite(SpriteSheet.icon_mouse[0]);\n            Sprite.icon_mouse_rmb = initBasicSprite(SpriteSheet.icon_mouse[1]);\n\n            // Enemies\n            //Sprite.stabguts = SpriteSheet.stabguts.map(initBasicSprite);\n            //Sprite.spindoctor = SpriteSheet.spindoctor.map(initBasicSprite);\n\n            Sprite.moth = SpriteSheet.moth.map(initBasicSprite);\n\n            // Gore/blood\n            Sprite.gore = SpriteSheet.gore.map(initBasicSprite);\n\n            // GUI\n            //Sprite.hud_healthbar = SpriteSheet.hud_healthbar.map(initBasicSprite);\n            //Sprite.hud_healthbar.push(initDynamicSprite(createHealthChunk(Sprite.hud_healthbar[1].img)));\n            Sprite.hud_crosshair = SpriteSheet.hud_crosshair.map(initBasicSprite);\n\n            Sprite.hud_mouse = SpriteSheet.cursor.map(data => initBasicSprite(data, { x: 0, y: 0 }))[0];\n\n            Sprite.bullet1 = SpriteSheet.bullet1.map(initBasicSprite);\n\n            Sprite.hud_tray_building = SpriteSheet.hud_tray_building.map(initBasicSprite);\n            Sprite.hud_tray_divider = SpriteSheet.hud_tray_divider.map(initBasicSprite);\n            Sprite.hud_tray_popup = SpriteSheet.hud_tray_popup.map(initBasicSprite);\n\n            Sprite.hud_wip = SpriteSheet.hud_wip.map(data => initBasicSprite(data, { x: -1, y: -1 }));\n\n            // Tiles\n            Sprite.tiles = SpriteSheet.tiles.map(initBasicSprite);\n            Sprite.tile_background = SpriteSheet.tile_background.map(initBasicSprite);\n\n            // Ghost enemy\n            Sprite.ghost = SpriteSheet.ghost.map(initBasicSprite);\n\n            // Buildins\n            Sprite.buildings = SpriteSheet.buildings.map(data => initBasicSprite(data, { x: 0, y: 8 }));\n\n            // Buttons\n            Sprite.buttons = SpriteSheet.buttons.map(initBasicSprite);\n\n            Sprite.tilebg = initDynamicSprite(createTileBg(Sprite.tiles[0].img));\n            Sprite.shadow = initDynamicSprite(createShadow());\n\n            // Dialog\n            //let dialog = SpriteSheet.dialog.map(initBasicSprite);\n            //Sprite.dialog_speech = initDynamicSprite(createDialogSpeech(dialog[0].img, dialog[2].img));\n            //Sprite.dialog_hint = initDynamicSprite(createDialogHint(dialog[1].img));\n        },\n\n        /**\n         * A small helper that draws a sprite onto a canvas, respecting the anchor point of\n         * the sprite. Note that the canvas should be PRE-TRANSLATED and PRE-ROTATED, if\n         * that's appropriate!\n         */\n        drawSprite(ctx, sprite, u, v) {\n            ctx.drawImage(sprite.img, u - sprite.anchor.x, v - sprite.anchor.y);\n        },\n\n        drawViewportSprite(sprite, pos, rotation) {\n            let { u, v } = this.viewportSprite2uv(\n                sprite,\n                pos\n            );\n            if (rotation) {\n                Viewport.ctx.save();\n                Viewport.ctx.translate(u + sprite.anchor.x, v + sprite.anchor.y);\n                Viewport.ctx.rotate(rotation);\n                Viewport.ctx.drawImage(\n                    sprite.img,\n                    -sprite.anchor.x,\n                    -sprite.anchor.y\n                );\n                Viewport.ctx.restore();\n            } else {\n                Viewport.ctx.drawImage(sprite.img, u, v);\n            }\n        },\n\n        viewportSprite2uv(sprite, pos) {\n            return {\n                u: pos.x - sprite.anchor.x - Camera.pos.x + Viewport.center.u,\n                v: pos.y - sprite.anchor.y - Camera.pos.y + Viewport.center.v\n            };\n        },\n\n        getDynamicTile(bitmask) {\n            if (!this.tiles[bitmask + TILE_DYNAMIC - 1]) {\n                this.tiles[bitmask + TILE_DYNAMIC - 1] = initDynamicSprite(createDynamicTile(this.tiles, bitmask), { x: 0, y: 0 });\n            }\n\n            return this.tiles[bitmask + TILE_DYNAMIC - 1];\n        }\n    };\n\n    // Sprite utility functions\n\n    function initBasicSprite(data, anchor) {\n        return initDynamicSprite(loadCacheSlice(...data), anchor);\n    }\n\n    function initDynamicSprite(source, anchor) {\n        let w = source.width,\n            h = source.height;\n\n        return {\n            img: source,\n            // Hack! Using a flat `.map(initBasicSprite)` is actually going to pass the\n            // element INDEX as second argument, resulting in \"anchor=1\". The right solution\n            // here is \"typeof anchor === 'object' ?\", but to save bytes I avoid using\n            // the typeof and instanceof keywords anywhere in the codebase. Hence,\n            // \"anchor && anchor.x\".\n            anchor: (typeof anchor === 'object') ? anchor : { x: (w / 2) | 0, y: (h / 2) | 0 }\n        };\n    }\n\n    function loadCacheSlice(x, y, w, h) {\n        const source = Sprite.sheet;\n        const sliceCanvas = createCanvas(w, h);\n        sliceCanvas.ctx.drawImage(source, x, y, w, h, 0, 0, w, h);\n        return sliceCanvas.canvas;\n    }\n\n    // Given wall tile, create a full screen tiled version to render in background\n    function createTileBg(source) {\n        let canvas = createCanvas(544, 334);\n        for (let y = 0; y < 334; y += 32) {\n            for (let x = 0; x < 544; x += 32) {\n                canvas.ctx.drawImage(source, x, y);\n            }\n        }\n        return canvas.canvas;\n    }\n\n    // \"Shadow\" overlay (gives flickering shadows in corners)\n    function createShadow() {\n        let canvas = createCanvas(500, 500);\n        let gradient = canvas.ctx.createRadialGradient(\n            250,\n            250,\n            0,\n            250,\n            250,\n            250\n        );\n        gradient.addColorStop(0.3, rgba(0, 0, 0, 0));\n        gradient.addColorStop(1, rgba(0, 0, 0, 0.9));\n        canvas.ctx.fillStyle = gradient;\n        canvas.ctx.fillRect(0, 0, 500, 500);\n        return canvas.canvas;\n    }\n\n    function createDynamicTile(tiles, bitmask) {\n        let canvas = createCanvas(TILE_SIZE, TILE_SIZE);\n\n        // First, we render outer corners\n\n        if (bitmask & 0b100_000_000) {\n            canvas.ctx.drawImage(tiles[TILE_CORNER_OUTER - 1].img, 0, 0, 4, 4, 0, 0, 4, 4);\n        }\n        if (bitmask & 0b001_000_000) {\n            canvas.ctx.drawImage(tiles[TILE_CORNER_OUTER - 1].img, 5, 0, 3, 3, 5, 0, 3, 3);\n        }\n        if (bitmask & 0b000_000_001) {\n            canvas.ctx.drawImage(tiles[TILE_CORNER_OUTER - 1].img, 6, 6, 2, 2, 6, 6, 2, 2);\n        }\n        if (bitmask & 0b000_000_100) {\n            canvas.ctx.drawImage(tiles[TILE_CORNER_OUTER - 1].img, 0, 5, 3, 3, 0, 5, 3, 3);\n        }\n\n        // Next we render standard walls (potentially overwriting outer corners above)\n\n        if (bitmask & 0b000_001_000) {\n            canvas.ctx.drawImage(tiles[TILE_WALL_LEFT - 1].img, 5, 0, 3, 8, 5, 0, 3, 8);\n        }\n        if (bitmask & 0b000_100_000) {\n            canvas.ctx.drawImage(tiles[TILE_WALL_RIGHT - 1].img, 0, 0, 4, 8, 0, 0, 4, 8);\n        }\n        if (bitmask & 0b000_000_010) {\n            canvas.ctx.drawImage(tiles[TILE_WALL_TOP - 1].img, 0, 5, 8, 3, 0, 5, 8, 3);\n        }\n        if (bitmask & 0b010_000_000) {\n            canvas.ctx.drawImage(tiles[TILE_WALL_BOTTOM - 1].img, 0, 0, 8, 4, 0, 0, 8, 4);\n        }\n\n        // Next we render inner corners (potentially overwriting parts of walls above)\n\n        if ((bitmask & 0b010_100_000) === 0b010_100_000) {\n            canvas.ctx.drawImage(tiles[TILE_CORNER_INNER - 1].img, 0, 0, 5, 5, 0, 0, 5, 5);\n        }\n        if ((bitmask & 0b010_001_000) === 0b010_001_000) {\n            canvas.ctx.drawImage(tiles[TILE_CORNER_INNER - 1].img, 4, 0, 4, 4, 4, 0, 4, 4);\n        }\n        if ((bitmask & 0b000_001_010) === 0b000_001_010) {\n            canvas.ctx.drawImage(tiles[TILE_CORNER_INNER - 1].img, 4, 4, 4, 4, 4, 4, 4, 4);\n        }\n        if ((bitmask & 0b000_100_010) === 0b000_100_010) {\n            canvas.ctx.drawImage(tiles[TILE_CORNER_INNER - 1].img, 0, 4, 5, 4, 0, 4, 5, 4);\n        }\n\n        return canvas.canvas;\n    }\n\n    class DefeatScreen {\n        constructor() {\n            this.frames = 0;\n        }\n\n        update() {\n            this.frames++;\n\n            if (Input.pressed[Input.Action.TAP] && this.frames > 30) {\n                // Reset sequence\n                game.reset();\n            }\n\n            return true;\n        }\n\n        draw() {\n            //Viewport.ctx.fillStyle = rgba(13, 43, 69, clamp(this.frames / 200, 0, 1));\n            Viewport.ctx.fillStyle = rgba(36, 26, 20, clamp(this.frames / 200, 0, 1));\n            Viewport.ctx.fillRect(0, 0, Viewport.width, Viewport.height);\n\n            let width = Viewport.width - 32;\n            let x = 16;\n            let y = 16;\n\n            let message = 'DEFEAT... \\n' +\n                '                    \\n' +\n                'YOUR LAST MOTH GONE, THIS WORLD SLIPS FROM YOUR GRASP. YOU CURSE THE VILLAGE AND ITS INHABITANTS AS YOU TUMBLE TOWARDS THAT BLEAK BEYOND. \\n \\n'  +\n                'YOUR REIGN OF TERROR HAS ENDED. \\n \\n' +\n                'TAP TO TRY AGAIN!';\n\n            message = message.slice(0, this.frames);\n\n            Text.drawParagraph(\n                Viewport.ctx,\n                message,\n                x,\n                y,\n                width,\n                1,\n                1,\n                Text.duotone_red\n            );\n        }\n    }\n\n    /**\n     * Game state.\n     */\n    class Game {\n        init() {\n            Sprite.loadSpritesheet(() => {\n                Viewport.init();\n                Sprite.init();\n                Text.init();\n                Input.init();\n                Audio.init();\n                Hud.init();\n\n                Camera.init();\n                World.init();\n\n                window.addEventListener('blur', () => this.pause());\n                window.addEventListener('focus', () => this.unpause());\n\n                this.reset();\n\n                this.start();\n            });\n        }\n\n        reset() {\n            this.entities = [];\n            this.dialogPending = {};\n            this.dialogSeen = {};\n            this.roomsCleared = {};\n            this.shadowOffset = 0;\n            this.screenshakes = [];\n            this.monstersPending = [];\n            this.waveNumber = 0;\n            this.earth = 250;\n            this.blood = 0;\n            this.entities.push(new Moth(qr2xy(World.spawn)));\n            this.screen = undefined;\n            this.wave = undefined;\n            World.reset();\n\n            Camera.pos = centerxy(qr2xy(World.exit));\n            Camera.forceTarget = centerxy(qr2xy(World.spawn));\n        }\n\n        start() {\n            this.frame = 0;\n            this.framestamps = [0];\n            this.update();\n            window.requestAnimationFrame((xyz) => this.onFrame(xyz));\n        }\n\n        onFrame(currentms) {\n            let startTime= new Date().getTime();\n\n            /*this.framestamps.push(currentms);*/\n            if (this.framestamps.length >= 40) {\n                this.framestamps.shift();\n            }\n            this.fps = 1000 / ((this.framestamps[this.framestamps.length - 1] - this.framestamps[0]) / this.framestamps.length);\n\n            this.frame++;\n            Viewport.resize();\n            this.update();\n            this.draw(Viewport.ctx);\n            window.requestAnimationFrame((xyz) => this.onFrame(xyz));\n\n            let endTime = new Date().getTime();\n            this.framestamps.push(this.framestamps[this.framestamps.length - 1] + endTime - startTime);\n        }\n\n        update() {\n            if (!this.wave) {\n                this.wave = new Wave(this.waveNumber++);\n            }\n\n            // Pull in frame by frame button pushes / keypresses / mouse clicks\n            Input.update();\n\n            if (this.screen) {\n                if (this.screen.update()) return;\n            }\n\n            if (Input.pressed[Input.Action.TAP]) {\n                this.tap(Input.pointer);\n            }\n\n            Hud.update();\n\n            //if (Input.pressed[Input.Action.MENU]) {\n            //    this.paused ? this.unpause() : this.pause();\n            //}\n\n            if (this.paused) return;\n\n            // Handle Input\n\n            // End Handle Input\n\n            // perform any per-frame audio updates\n            Audio.update();\n\n            this.wave.update();\n\n            this.spawnMonsterIfPossible();\n\n            // Behavior (AI, player input, etc.)\n            //perform(this.entities); <-- cut to save space\n            console.log(game.entities);\n            for (let entity of game.entities) {\n                if (entity.think) entity.think();\n            }\n\n            // perform any queued damage\n            Damage.perform(this.entities);\n\n            // Movement (perform entity velocities to position)\n            Movement.perform(this.entities);\n\n            Camera.update();\n\n            // Culling (typically when an entity dies)\n            this.entities = this.entities.filter(entity => !entity.cull);\n            World.buildings = World.buildings.filter(building => !building.cull);\n\n            // Camera logic\n            /*let diff = {\n                x: this.player.pos.x - this.camera.pos.x,\n                y: this.player.pos.y - this.camera.pos.y\n            };\n            this.camera.pos.x += diff.x * 0.2;\n            this.camera.pos.y += diff.y * 0.2;*/\n\n            // Tick screenshakes and cull finished screenshakes\n            this.screenshakes = this.screenshakes.filter(screenshake =>\n                screenshake.update()\n            );\n\n            World.update();\n\n            if (this.entities.filter(e => e instanceof Moth).length === 0) {\n                game.screen = new DefeatScreen();\n            }\n\n            // Flickering shadows\n            if (game.frame % 6 === 0) this.shadowOffset = (Math.random() * 10) | 0;\n\n            // Intro screenshake\n            if (game.frame === 30) game.screenshakes.push(new ScreenShake(20, 20, 20));\n\n            // Initial \"click\" to get game started\n            if (Input.pressed[Input.Action.ATTACK] && !game.started) game.started = true;\n        }\n\n        draw() {\n            // Reset canvas transform and scale\n            Viewport.ctx.setTransform(1, 0, 0, 1, 0, 0);\n            Viewport.ctx.scale(Viewport.scale, Viewport.scale);\n\n            //Viewport.ctx.fillStyle = rgba(13, 43, 69, 1);\n            //Viewport.ctx.fillStyle = rgba(84, 78, 104, 1);\n            //Viewport.ctx.fillStyle = rgba(32, 60, 86, 1);\n            Viewport.ctx.fillStyle = rgba(36, 26, 20, 1);\n            Viewport.ctx.fillRect(0, 0, Viewport.width, Viewport.height);\n\n            // Render screenshakes (canvas translation)\n            /*\n            let shakeX = 0, shakeY = 0;\n            this.screenshakes.forEach(shake => {\n                shakeX += shake.x;\n                shakeY += shake.y;\n            });\n            Viewport.ctx.translate(shakeX, shakeY);\n            */\n\n            /*\n            Viewport.ctx.drawImage(\n                Sprite.shadow.img,\n                0, 0,\n                500, 500,\n                -this.shadowOffset, -this.shadowOffset,\n                Viewport.width + this.shadowOffset * 2,\n                Viewport.height + this.shadowOffset * 2\n            );\n            */\n\n            World.draw();\n\n            for (let entity of this.entities) {\n                if (!entity.z || entity.z < 100) entity.draw();\n            }\n\n            for (let entity of this.entities) {\n                if (entity.z && entity.z > 100) entity.draw();\n            }\n\n            World.drawLightmap();\n\n            Hud.draw();\n\n            if (game.frame < 120) {\n                Viewport.ctx.fillStyle = rgba(0, 0, 0, 1 - game.frame / 120);\n                Viewport.fillViewportRect();\n            }\n\n            /*\n            if (game.frame >= 30 && !game.started) {\n                //let width = Text.measureWidth(TITLE, 3);\n                Text.drawText(\n                    Viewport.ctx, TITLE, Viewport.center.u - Text.measureWidth(TITLE, 3) / 2, Viewport.center.v, 3,\n                    Text.white,\n                    Text.red\n                );\n            }\n            */\n\n            if (this.screen) {\n                this.screen.draw();\n            }\n\n            /*\n            if (game.frame % 100 === 0) {\n                let pos = {\n                    x: Math.random() * 100 - 50,\n                    y: Math.random() * 100 - 50\n                };\n                game.entities.push(new Ghost(pos));\n            }\n            */\n        }\n\n        pause() {\n            if (this.paused) return;\n            this.paused = true;\n            Audio.pause();\n        }\n\n        unpause() {\n            if (!this.paused) return;\n            this.paused = false;\n            Audio.unpause();\n        }\n\n        tap(uv) {\n            for (let ui of [Hud, World]) {\n                if (ui.tap(uv)) break;\n            }\n        }\n\n        activeMoths() {\n            return this.entities.filter(x => x instanceof Moth).length;\n        }\n\n        canAfford(earth) {\n            if (this.earth >= earth) {\n                return true;\n            }\n        }\n\n        payCost(earth) {\n            this.earth -= earth;\n        }\n\n        spawnMonsterIfPossible() {\n            let entityClass = this.monstersPending[0];\n\n            if (entityClass) {\n                // A spawn is attempted up to 10 times\n                for (let i = 0; i < 10; i++) {\n                    let q = Math.floor(Math.random() * World.floors[0].tiles[0].length);\n                    let r = Math.floor(Math.random() * World.floors[0].tiles.length);\n                    if (World.tiles[r][q] !== 1) {\n                        continue;\n                    }\n                    if (World.lightmap[r][q] !== 0) {\n                        continue;\n                    }\n\n                    let xy = qr2xy({ q, r });\n                    console.log('NEW monster' + xy.x + ',' + xy.y + ',' + World.lightmap[r][q]);\n                    game.entities.push(new entityClass(xy));\n                    this.monstersPending.shift();\n                    break;\n                }\n            }\n        }\n    }\n\n    const game = new Game();\n\n    /**\n     * Create and launch game.\n     */\n    game.init();\n\n})();\n"]}